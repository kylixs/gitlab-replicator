# GitLab 同步器 MVP 功能清单

## 📋 文档说明

本文档定义 GitLab 同步器 MVP（最小可行产品）的功能清单，**仅列出功能点，不包含具体设计和实现**。

**MVP 默认方案**：**Push Mirror**

---

## 🎯 MVP 目标

**核心价值**：通过批量配置 GitLab Push Mirror 实现项目自动同步

**技术方案**：
- 🎯 **默认：Push Mirror 方案**（利用 GitLab 原生功能）
- ⚠️ **前提条件**：需要源 GitLab 管理员权限

**范围**：
- ✅ Git 仓库自动同步（分支、标签、提交历史）
- ✅ 保持分组和项目路径一致
- ✅ 批量配置和管理 Push Mirror
- ✅ 监控 Mirror 状态和健康检查
- ✅ 基础日志和报告
- ❌ 暂不包含 Issues/MR 等元数据同步（后续版本）

---

## ✅ P0 功能（核心必需）

### 1. 配置管理

- [ ] **配置文件支持**
  - 支持 YAML 格式配置文件
  - 配置源 GitLab（URL、Token）
  - 配置目标 GitLab（URL、Token）
  - 配置同步范围（分组列表、项目过滤规则）
  - 支持环境变量（敏感信息）

- [ ] **配置验证**
  - 配置文件格式验证
  - 必填字段检查
  - URL 格式验证
  - 源和目标连接测试
  - Token 权限验证

### 2. 项目发现

- [ ] **源项目列表获取**
  - 按分组路径获取项目列表
  - 递归获取子分组项目
  - 项目过滤（排除归档、空仓库等）
  - 显示项目统计信息

- [ ] **项目信息收集**
  - 项目 ID、路径、名称
  - 默认分支
  - 可见性（Private/Internal/Public）
  - 仓库大小（预估）

### 3. 目标准备

- [ ] **分组创建**
  - 检查目标分组是否存在
  - 按层级顺序创建分组（父分组优先）
  - 保持分组路径与源一致
  - 设置分组可见性

- [ ] **项目创建**
  - 检查目标项目是否存在
  - 创建空项目（与源路径一致）
  - 设置项目可见性
  - 处理冲突（已存在项目的处理策略）

### 4. Push Mirror 配置

- [ ] **批量配置 Remote Mirror**
  - 调用 GitLab API 创建 Push Mirror
  - 设置目标仓库 URL（含认证信息）
  - 配置 Mirror 选项（only_protected_branches、keep_divergent_refs）
  - 保存 Mirror ID（用于后续管理）

- [ ] **首次同步触发**
  - 手动触发首次 Mirror 同步
  - 批量触发所有项目同步
  - 并发控制（避免 API 限流）

- [ ] **Mirror 状态监控**
  - 轮询查询 Mirror 同步状态
  - 实时显示同步进度
  - 检测同步完成/失败
  - 超时处理

### 5. Mirror 管理

- [ ] **Mirror 健康检查**
  - 定期检查 Mirror 配置是否存在
  - 检查 Mirror 是否启用
  - 检查最后同步时间
  - 检测长时间未同步的 Mirror

- [ ] **Mirror 操作**
  - 手动触发 Mirror 同步
  - 更新 Mirror 配置
  - 禁用/启用 Mirror
  - 删除 Mirror 配置

### 6. 状态管理

- [ ] **Mirror 状态记录**
  - 记录每个项目的 Mirror ID
  - 记录 Mirror 状态（configured/syncing/synced/failed）
  - 记录最后同步时间、同步状态
  - 记录失败原因和错误信息
  - 状态持久化（SQLite 数据库）

- [ ] **状态查询**
  - 查看所有 Mirror 状态
  - 按状态过滤（已同步/失败/同步中）
  - 查看特定项目的 Mirror 详情
  - 显示 Mirror 统计信息
  - 导出状态报告

### 7. 日志记录

- [ ] **结构化日志**
  - JSON 格式日志
  - 记录 Mirror 创建/配置事件
  - 记录同步开始/完成事件
  - 记录 API 调用和响应
  - 记录错误和异常

- [ ] **日志级别**
  - 支持 DEBUG/INFO/WARN/ERROR
  - 可配置日志级别

- [ ] **日志输出**
  - 控制台输出（彩色）
  - 文件输出
  - 日志文件轮转

### 8. 错误处理

- [ ] **错误分类**
  - 致命错误（连接失败、认证失败 - 停止执行）
  - 可恢复错误（网络超时、API 限流 - 重试）
  - 警告（Mirror 已存在 - 记录后继续）

- [ ] **重试机制**
  - 网络错误自动重试（最多 3 次）
  - API 限流处理（429 错误，等待 Retry-After）
  - 指数退避策略（1s, 2s, 4s, 8s...）
  - 超时处理（Mirror 同步超时）

- [ ] **失败 Mirror 处理**
  - 记录失败的 Mirror 及原因
  - 继续配置其他项目的 Mirror
  - 支持手动重试失败项目
  - 支持重新配置 Mirror（删除后重建）

### 9. 进度监控

- [ ] **配置阶段进度**
  - 显示总项目数 / 已配置 Mirror 数
  - 当前正在配置的项目
  - 配置进度百分比

- [ ] **同步阶段进度**
  - 显示同步中的 Mirror 数量
  - 已完成 / 失败 / 进行中统计
  - 实时更新同步状态
  - 预计剩余时间

- [ ] **进度持久化**
  - 保存配置进度到数据库
  - 保存 Mirror 同步状态
  - 中断后可查看已完成项目

### 10. 报告生成

- [ ] **Push Mirror 配置报告**
  - 执行摘要（总项目数、成功配置数、失败数、耗时）
  - 成功配置的 Mirror 列表
  - 失败的项目列表及原因
  - 跳过的项目列表及原因

- [ ] **同步状态报告**
  - Mirror 同步统计（已同步、失败、同步中）
  - 最后同步时间统计
  - 失败 Mirror 的错误详情

- [ ] **报告格式**
  - 纯文本格式（易读）
  - JSON 格式（机器可读）

### 11. CLI 命令

- [ ] **基础命令**
  - 测试连接：`test-connection`
  - 发现项目：`discover`
  - 配置 Mirror：`run`（执行完整流程）
  - 查看状态：`status`
  - 重试失败：`retry`
  - 清理 Mirror：`cleanup`（删除 Mirror 配置）

- [ ] **命令选项**
  - 指定配置文件：`--config`
  - 试运行模式：`--dry-run`（仅模拟，不实际配置）
  - 并发数控制：`--concurrency`
  - 跳过已存在：`--skip-existing`
  - 输出格式：`--format` (text/json)

### 12. 并发控制

- [ ] **Mirror 配置并发**
  - 支持多个项目并发配置 Mirror
  - 可配置并发数（默认 5-10）
  - API 限流保护（429 错误处理）

- [ ] **Mirror 同步监控并发**
  - 批量查询多个 Mirror 状态
  - 并发轮询（提高监控效率）
  - 避免 API 过载

---

## 🔶 P1 功能（重要增强）

### 13. 配置向导

- [ ] **交互式配置生成**
  - 引导用户输入源/目标 GitLab 信息
  - 自动测试连接和权限
  - 引导选择分组和过滤规则
  - 生成配置文件

### 14. Mirror 优化

- [ ] **智能过滤**
  - 检测项目是否有更新（last_activity_at）
  - 跳过长时间无更新的项目
  - 优先配置活跃项目的 Mirror

- [ ] **Mirror 配置优化**
  - 检测已存在的 Mirror（避免重复配置）
  - 更新现有 Mirror 配置（而非重建）
  - 批量操作优化

### 15. 用户体验

- [ ] **进度条美化**
  - 彩色进度条（rich 库）
  - 实时显示配置/同步速度
  - 更友好的错误提示和建议

- [ ] **详细帮助文档**
  - 命令帮助信息（--help）
  - Mirror 错误处理建议
  - 常见问题 FAQ

---

## 🔷 P2 功能（可选功能）

### 16. Mirror 健康监控

- [ ] **定期健康检查**
  - 定时检查所有 Mirror 状态
  - 检测长时间未同步的 Mirror
  - 检测失败的 Mirror
  - 生成健康报告

### 17. 告警机制

- [ ] **Mirror 异常告警**
  - Mirror 配置失败告警
  - Mirror 同步失败告警
  - 长时间未同步告警
  - 支持邮件/钉钉/企业微信

### 18. Web UI（可选）

- [ ] **基础 Web 界面**
  - Mirror 状态 Dashboard
  - 项目列表和 Mirror 信息
  - 手动触发 Mirror 同步
  - 查看 Mirror 日志

---

## 📊 MVP 验收标准

### 功能验收

- [ ] 能够从源 GitLab 获取指定分组的所有项目
- [ ] 能够在目标 GitLab 自动创建分组和空项目
- [ ] 能够批量配置 Push Mirror（至少 10 个项目）
- [ ] 能够监控 Mirror 首次同步进度
- [ ] 能够查询所有 Mirror 状态和生成报告
- [ ] 能够重试失败的 Mirror 配置
- [ ] 能够手动触发 Mirror 同步
- [ ] 有完整的日志记录

### 性能验收

- [ ] 能够处理至少 100 个项目
- [ ] 支持 5-10 个并发配置 Mirror
- [ ] 配置单个 Mirror 平均耗时 < 5 秒
- [ ] 能够处理 1GB+ 大小的仓库（首次同步可能需 30 分钟+）

### 质量验收

- [ ] 配置文件验证完整
- [ ] 错误提示清晰（含修复建议）
- [ ] 日志可追溯（JSON 格式）
- [ ] Mirror 状态持久化到数据库
- [ ] API 错误重试机制完善

---

## 🚀 开发计划

### Week 1: 基础框架

- 配置管理（配置文件加载、验证）
- GitLab API 客户端封装
- 项目发现（获取项目列表、过滤）
- 目标准备（创建分组、创建项目）
- 基础 CLI 命令框架

### Week 2: Push Mirror 核心

- Push Mirror 批量配置
- Mirror 首次同步触发
- Mirror 状态监控（轮询）
- 状态数据库（SQLite）
- 基础日志记录

### Week 3: 错误处理和完善

- 错误分类和重试机制
- API 限流处理
- 进度监控和显示
- Mirror 状态查询命令
- 重试失败 Mirror

### Week 4: 测试和文档

- 报告生成（配置报告、状态报告）
- CLI 命令完善（cleanup、日志查询）
- 集成测试（真实 GitLab 环境）
- 用户文档编写
- 性能测试和优化

---

## 📝 功能优先级说明

### P0（核心必需）
- 必须在 MVP 中实现
- 没有这些功能 MVP 无法交付
- 预计开发时间：3-4 周

### P1（重要增强）
- 显著提升用户体验
- 可在 MVP 后第一个迭代实现
- 预计开发时间：1 周

### P2（可选功能）
- 锦上添花的功能
- 可在后续版本实现
- 根据用户反馈决定是否开发

---

## 🎯 MVP 与完整版对比

| 功能 | MVP (Push Mirror) | 完整版 (Clone & Push + 元数据) |
|------|------------------|------------------------------|
| **Git 仓库同步** | ✅ (GitLab 自动) | ✅ (手动控制) |
| **分组/项目路径一致** | ✅ | ✅ |
| **自动持续同步** | ✅ (1-5 分钟) | ⚠️ (需定时任务) |
| **需要源权限** | ✅ 需要 | ❌ 不需要 |
| **Issues 同步** | ❌ | ✅ |
| **MR 同步** | ❌ | ✅ |
| **Wiki 同步** | ❌ | ✅ |
| **用户映射** | ❌ | ✅ |
| **本地存储** | ❌ 不需要 | ✅ 需要 |
| **开发周期** | 4 周 | 8-10 周 |
| **维护成本** | 低 | 中 |

---

## 📌 关键决策

### 1. MVP 同步策略选择

**默认采用：Push Mirror**

理由：
- ✅ 利用 GitLab 原生功能，稳定可靠
- ✅ 自动持续同步，无需维护定时任务
- ✅ 不占用本地存储空间
- ✅ 开发周期短（4 周）
- ⚠️ 需要源 GitLab 管理员权限（前提条件）

**适用场景**：
- 有源 GitLab 管理权限
- 仅需要 Git 仓库同步
- 希望快速上线

### 2. MVP 不包含元数据同步

**理由**：
- Git 仓库同步是核心需求
- Push Mirror 本身不支持元数据同步
- 元数据同步需要另外开发（复杂度高）
- MVP 聚焦快速验证可行性
- 后续版本可切换到 Clone & Push + API 同步方案

### 3. MVP 状态存储方案

**采用：SQLite**

理由：
- 轻量级，无需额外部署
- 足够存储 Mirror 配置和状态
- 后续可平滑迁移到 PostgreSQL

### 4. MVP 日志方案

**采用：结构化 JSON 日志**

理由：
- 便于追踪 Mirror 配置和同步过程
- 支持故障排查
- 易于集成日志分析工具

### 5. Push Mirror 的局限性

**已知限制**：
- ❌ 无法同步 Issues/MR/Wiki
- ❌ 无法同步 Git LFS 对象（需手动处理）
- ⚠️ 依赖 GitLab 调度（1-5 分钟延迟）
- ⚠️ 删除的分支/标签同步行为有限制

**应对策略**：
- MVP 聚焦 Git 仓库同步
- 元数据同步留待后续版本（采用 API 方案）
- 文档中明确说明限制

---

**最后更新**: 2025-12-13
**文档版本**: v1.0
