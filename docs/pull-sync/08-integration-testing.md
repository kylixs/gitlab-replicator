# 模块 8: 集成与性能测试 (Integration & Performance Testing)

**状态**: ⏸️ 待处理 (Pending)

**目标**: 编写完整的端到端集成测试和性能测试，验证 Pull Sync 功能的正确性和性能。

**预计时间**: 3-4天

---

## ⚠️ 重要提醒：任务状态管理规范

**【必须】在开始处理下面的每个子任务前及后需要修改其任务状态：**

1. **开始任务前**：将任务状态从 `⏸️ 待处理 (Pending)` 修改为 `🔄 进行中 (In Progress)`
2. **完成任务后**：将任务状态修改为 `✅ 已完成 (Completed)` 或 `❌ 失败 (Failed)`
3. **更新位置**：在本文档对应任务的 `**状态**:` 行进行修改

**状态标记说明**：
- `⏸️ 待处理 (Pending)` - 任务未开始
- `🔄 进行中 (In Progress)` - 任务正在处理中
- `✅ 已完成 (Completed)` - 任务成功完成，测试通过
- `❌ 失败 (Failed)` - 任务失败，需要修复
- `⚠️ 阻塞 (Blocked)` - 任务被依赖阻塞

---

## 端到端集成测试

### T8.1 Pull Sync 完整流程测试（首次同步）
**状态**: ✅ 已完成 (Completed)
**依赖**: 模块1-5 全部完成

**任务目标**:
- 测试完整的 Pull Sync 首次同步流程
- 验证数据完整性和正确性
- 确保所有组件协同工作

**测试场景**:
```
1. 准备阶段
   - 在源 GitLab 创建测试项目（含多个分支、标签）
   - 配置 Pull Sync 环境

2. 项目发现
   - 调用项目发现 API
   - 验证创建了 SYNC_PROJECT, PULL_SYNC_CONFIG, SYNC_TASK

3. 调度执行
   - 触发调度器
   - 验证任务被调度执行

4. Pull 执行
   - 监控 Pull sync 过程
   - 验证本地仓库克隆成功
   - 验证所有分支和标签都存在

5. 目标推送
   - 验证目标 GitLab 项目创建
   - 验证所有分支和标签被推送
   - 验证提交历史完整

6. 状态更新
   - 验证任务状态更新为 success
   - 验证 next_run_at 按调度间隔更新
   - 验证事件记录完整
```


**验收标准**:
- 所有测试步骤通过
- 数据完整性验证通过
- 提交历史验证通过
- 无数据丢失

**测试要求**:
- 测试至少 3 个不同项目
- 测试不同大小的仓库（小、中、大）
- 测试包含子模块的仓库
- 测试各种分支和标签组合

**提交**: `test(integration): add full Pull sync flow test`

---

### T8.2 增量同步与变更检测测试
**状态**: ✅ 已完成 (Completed)
**依赖**: T8.1

**任务目标**:
- 测试增量同步功能
- 验证变更检测机制（git ls-remote）
- 验证无变更时快速跳过

**测试场景**:
```
1. 首次同步完成后
   - 记录首次同步完成时间

2. 无变更场景
   - 触发调度器
   - 验证通过 git ls-remote 检测到无变更
   - 验证跳过执行（耗时 <1s）
   - 验证状态保持 success

3. 有变更场景
   - 向源仓库推送新提交
   - 触发调度器
   - 验证检测到变更
   - 验证执行增量同步
   - 验证新提交被同步到目标

4. 多分支变更
   - 在多个分支推送变更
   - 验证所有变更都被同步

5. 标签变更
   - 添加新标签
   - 验证标签被同步
```

**验收标准**:
- 无变更时快速跳过（<1s）
- 有变更时正确同步
- 增量同步完整性验证
- 性能符合预期

**测试要求**:
- 测试无变更场景
- 测试单分支变更
- 测试多分支变更
- 测试标签变更
- 测试性能指标

**提交**: `test(integration): add incremental sync test`

---

### T8.3 Webhook 实时同步测试
**状态**: ⏸️ 待处理 (Pending)
**依赖**: T8.1, 模块5 - Webhook

**任务目标**:
- 测试 Webhook 触发的实时同步
- 验证自动初始化功能
- 验证防抖逻辑

**测试场景**:
```
1. 新项目 Webhook
   - 向 Webhook 端点发送 Push 事件（新项目）
   - 验证自动创建项目配置
   - 验证立即调度执行
   - 验证同步在 2 分钟内完成

2. 已存在项目 Webhook
   - 向 Webhook 端点发送 Push 事件（已存在项目）
   - 验证立即调度执行
   - 验证同步快速完成

3. 防抖测试
   - 连续发送多个 Webhook 事件
   - 验证 2 分钟内的重复事件被忽略
   - 验证只执行一次同步

4. 并发 Webhook
   - 同时发送多个不同项目的 Webhook
   - 验证所有项目都被处理
   - 验证无冲突或死锁
```

**验收标准**:
- Webhook 响应时间 <100ms
- 自动初始化成功
- 同步在 2 分钟内完成
- 防抖逻辑生效

**测试要求**:
- 测试新项目自动初始化
- 测试已存在项目处理
- 测试防抖逻辑
- 测试并发 Webhook
- 测试响应时间

**提交**: `test(integration): add webhook realtime sync test`

---

### T8.4 混合 Push/Pull 项目测试
**状态**: ⏸️ 待处理 (Pending)
**依赖**: T8.1

**任务目标**:
- 测试 Push Mirror 和 Pull Sync 共存
- 验证两种同步方式互不干扰
- 验证调度器正确处理混合任务

**测试场景**:
```
1. 同时存在 Push 和 Pull 项目
   - 创建 5 个 Push Mirror 项目
   - 创建 5 个 Pull Sync 项目
   - 触发调度器

2. 验证独立执行
   - 验证 Pull 任务按优先级调度
   - 验证 Push 任务按轮询调度
   - 验证互不干扰

3. 资源竞争测试
   - 在高并发下执行混合任务
   - 验证无资源竞争
   - 验证性能稳定
```

**验收标准**:
- Push 和 Pull 项目都成功同步
- 互不干扰
- 资源使用合理
- 性能稳定

**测试要求**:
- 测试混合项目场景
- 测试并发执行
- 测试资源竞争
- 测试性能影响

**提交**: `test(integration): add mixed Push/Pull projects test`

---

### T8.5 错误处理和自动禁用测试
**状态**: ⏸️ 待处理 (Pending)
**依赖**: T8.1

**任务目标**:
- 测试错误处理机制
- 验证重试逻辑（指数退避）
- 验证自动禁用功能

**测试场景**:
```
1. 网络错误重试
   - 模拟网络故障
   - 验证重试间隔：5min, 10min, 20min, 40min, 80min
   - 验证指数退避生效

2. 认证错误处理
   - 模拟认证失败
   - 验证立即失败（不重试）
   - 验证错误记录完整

3. 自动禁用测试
   - 触发 5 次连续失败
   - 验证项目被自动禁用
   - 验证后续调度跳过该项目

4. 手动恢复测试
   - 使用 API 重置失败计数
   - 验证项目重新启用
   - 验证同步恢复正常
```

**验收标准**:
- 重试间隔符合指数退避
- 5 次失败后自动禁用
- 错误日志完整
- 手动恢复功能正常

**测试要求**:
- 测试各种错误类型
- 测试重试逻辑
- 测试自动禁用
- 测试手动恢复

**提交**: `test(integration): add error handling test`

---

## 性能测试

### T8.6 100 项目并发同步性能测试
**状态**: ⏸️ 待处理 (Pending)
**依赖**: T8.1-T8.5

**任务目标**:
- 测试大规模并发同步性能
- 测量吞吐量和资源使用
- 验证系统稳定性

**测试目标**:
- 同步 100 个项目
- 完成时间：10-15 分钟（非高峰）
- 吞吐量：6-10 项目/分钟
- CPU 使用率：< 80%
- 内存使用：< 2GB

**验收标准**:
- 完成时间 <15 分钟
- 吞吐量 >6 项目/分钟
- 资源使用合理
- 无失败项目

**提交**: `test(performance): add 100 projects concurrent sync test`

---

### T8.7 1000+ 任务调度效率测试
**状态**: ⏸️ 待处理 (Pending)
**依赖**: T8.6

**任务目标**:
- 测试调度器处理大量任务的效率
- 测量调度开销和查询性能
- 验证可扩展性

**测试目标**:
- 创建 1000 个任务
- 调度时间：<5 秒
- 查询时间：<1 秒
- 内存使用：<500MB

**验收标准**:
- 调度时间 <5 秒
- 查询性能良好
- 内存使用合理
- 可扩展到更大规模

**提交**: `test(performance): add 1000 tasks scheduling test`

---

### T8.8 Webhook 突发请求负载测试
**状态**: ⏸️ 待处理 (Pending)
**依赖**: T8.3

**任务目标**:
- 测试 Webhook 处理突发请求的能力
- 测量响应时间和处理能力
- 验证无丢失和错误

**测试目标**:
- 并发 100 个 Webhook 请求
- 响应时间：全部 <100ms
- 处理成功率：100%
- 无请求丢失

**验收标准**:
- 所有请求 <100ms
- 成功率 100%
- 无请求丢失
- 异步处理正常

**提交**: `test(performance): add webhook burst load test`

---

## 模块输出

- ⏸️ 5 个端到端集成测试
- ⏸️ 3 个性能测试
- ⏸️ 测试报告和性能基准
- ⏸️ CI/CD 集成配置

---

## 测试环境要求

1. **GitLab 实例**: 源和目标 GitLab（Docker）
2. **数据库**: MySQL 8.0
3. **资源**: 至少 4GB RAM, 4 CPU cores
4. **网络**: 稳定的网络连接
5. **工具**: JMeter, Gatling（可选）

---

## 注意事项

1. **数据隔离**: 每个测试使用独立的测试数据
2. **清理**: 测试后清理测试项目和数据
3. **超时**: 设置合理的超时时间
4. **并发**: 使用 CountDownLatch 和 Awaitility
5. **断言**: 使用 AssertJ 提供清晰的错误信息
