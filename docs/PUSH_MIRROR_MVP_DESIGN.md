# Push Mirror æ–¹æ¡ˆ MVP è¯¦ç»†è®¾è®¡

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£æè¿°åŸºäº GitLab Push Mirror åŠŸèƒ½çš„åŒæ­¥å·¥å…·çš„è¯¦ç»†è®¾è®¡æ–¹æ¡ˆã€‚

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… æœ‰æº GitLab çš„ç®¡ç†å‘˜æƒé™ï¼ˆå¯é…ç½® Push Mirrorï¼‰
- âœ… ä¸»è¦éœ€æ±‚æ˜¯ Git ä»“åº“åŒæ­¥ï¼ˆä»£ç ã€åˆ†æ”¯ã€æ ‡ç­¾ã€æäº¤å†å²ï¼‰
- âš ï¸ ä¸éœ€è¦åŒæ­¥ Issues/MR/Wiki ç­‰å…ƒæ•°æ®ï¼ˆPush Mirror ä¸æ”¯æŒï¼‰

**æŠ€æœ¯æ¶æ„**ï¼š
- **å®¢æˆ·ç«¯/æœåŠ¡ç«¯åˆ†ç¦»**ï¼šCLI å®¢æˆ·ç«¯é€šè¿‡ HTTP RESTful API ä¸åŒæ­¥æœåŠ¡é€šä¿¡
- **ç®€å•èº«ä»½è®¤è¯**ï¼šæ”¯æŒ API Token è®¤è¯æœºåˆ¶
- **çŠ¶æ€æŒä¹…åŒ–**ï¼šä½¿ç”¨ SQLite æ•°æ®åº“å­˜å‚¨åŒæ­¥çŠ¶æ€

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„

**æ¶æ„æ¨¡å¼**ï¼šå®¢æˆ·ç«¯/æœåŠ¡ç«¯åˆ†ç¦»

**ç»„ä»¶è¯´æ˜**ï¼š

1. **CLI å®¢æˆ·ç«¯ (gitlab-mirror-cli)**
   - ç”¨æˆ·äº¤äº’ç•Œé¢ï¼ˆå‘½ä»¤è¡Œï¼‰
   - é…ç½®æ–‡ä»¶ç®¡ç†
   - é€šè¿‡ HTTP RESTful API ä¸åŒæ­¥æœåŠ¡é€šä¿¡
   - æ”¯æŒ API Token è®¤è¯

2. **åŒæ­¥æœåŠ¡ (gitlab-mirror-service)**
   - HTTP RESTful API æœåŠ¡å™¨
   - æ‰§è¡Œå®é™…çš„åŒæ­¥é€»è¾‘
   - ç®¡ç† GitLab API è°ƒç”¨
   - çŠ¶æ€æŒä¹…åŒ–ï¼ˆSQLiteï¼‰
   - æ—¥å¿—è®°å½•å’Œç›‘æ§

3. **çŠ¶æ€æ•°æ®åº“ (SQLite)**
   - å­˜å‚¨é¡¹ç›®åŒæ­¥çŠ¶æ€
   - å­˜å‚¨ Push Mirror é…ç½®ä¿¡æ¯
   - å­˜å‚¨æ‰§è¡Œå†å²å’Œé”™è¯¯æ—¥å¿—

**é€šä¿¡æµç¨‹**ï¼š
```
ç”¨æˆ· â†’ CLI å®¢æˆ·ç«¯ â†’ [HTTP REST API + Token] â†’ åŒæ­¥æœåŠ¡ â†’ GitLab API (æº/ç›®æ ‡)
                                                    â†“
                                              çŠ¶æ€æ•°æ®åº“ (SQLite)
```

**èº«ä»½è®¤è¯**ï¼š
- CLI å®¢æˆ·ç«¯åœ¨é…ç½®æ–‡ä»¶ä¸­å­˜å‚¨ API Token
- æ¯æ¬¡ HTTP è¯·æ±‚æºå¸¦ Tokenï¼ˆAuthorization Headerï¼‰
- åŒæ­¥æœåŠ¡éªŒè¯ Token æœ‰æ•ˆæ€§
- æ”¯æŒå¤šä¸ª Tokenï¼ˆå¤šç”¨æˆ·åœºæ™¯ï¼‰

---

## ğŸ“Š æ ¸å¿ƒå®ä½“åŠå…³ç³»

### ER å®ä½“å…³ç³»å›¾

```mermaid
erDiagram
    SYNC_PROJECT ||--|| SOURCE_PROJECT_INFO : "å…³è”æºé¡¹ç›®ä¿¡æ¯"
    SYNC_PROJECT ||--|| TARGET_PROJECT_INFO : "å…³è”ç›®æ ‡é¡¹ç›®ä¿¡æ¯"
    SYNC_PROJECT ||--o| PUSH_MIRROR_CONFIG : "Push Mirroré…ç½®(å¯é€‰)"
    SYNC_PROJECT ||--o{ SYNC_EVENT : "äº§ç”Ÿäº‹ä»¶"

    SYNC_PROJECT {
        int id PK
        string project_key UK "é¡¹ç›®å”¯ä¸€æ ‡è¯†(æºè·¯å¾„)"
        string sync_method "åŒæ­¥æ–¹å¼: push_mirror/pull_mirror/clone_push"
        string sync_status "åŒæ­¥çŠ¶æ€: pending/target_created/mirror_configured/active/failed"
        boolean enabled "æ˜¯å¦å¯ç”¨åŒæ­¥"
        string error_message "é”™è¯¯ä¿¡æ¯"
        timestamp created_at "é¦–æ¬¡å‘ç°æ—¶é—´"
        timestamp updated_at
    }

    SOURCE_PROJECT_INFO {
        int id PK
        int sync_project_id FK
        int gitlab_project_id "GitLabé¡¹ç›®ID"
        string path_with_namespace "é¡¹ç›®å®Œæ•´è·¯å¾„"
        string group_path "åˆ†ç»„è·¯å¾„"
        string name "é¡¹ç›®åç§°"
        string default_branch "é»˜è®¤åˆ†æ”¯"
        string visibility "å¯è§æ€§: private/internal/public"
        boolean archived "æ˜¯å¦å½’æ¡£"
        boolean empty_repo "æ˜¯å¦ç©ºä»“åº“"
        int star_count "æ˜Ÿæ ‡æ•°"
        int fork_count "Forkæ•°"
        timestamp last_activity_at "æœ€åæ´»åŠ¨æ—¶é—´"
        json metadata "å…¶ä»–å…ƒæ•°æ®(JSON)"
        timestamp synced_at "ä¿¡æ¯åŒæ­¥æ—¶é—´"
        timestamp updated_at
    }

    TARGET_PROJECT_INFO {
        int id PK
        int sync_project_id FK
        int gitlab_project_id "GitLabé¡¹ç›®ID"
        string path_with_namespace "é¡¹ç›®å®Œæ•´è·¯å¾„"
        string name "é¡¹ç›®åç§°"
        string visibility "å¯è§æ€§"
        string status "çŠ¶æ€: not_exist/creating/created/ready/error/deleted"
        timestamp last_checked_at "æœ€åæ£€æŸ¥æ—¶é—´"
        string error_message "é”™è¯¯ä¿¡æ¯"
        int retry_count "é‡è¯•æ¬¡æ•°"
        timestamp created_at "åˆ›å»ºæ—¶é—´"
        timestamp updated_at
    }

    PUSH_MIRROR_CONFIG {
        int id PK
        int sync_project_id FK "å…³è”åŒæ­¥é¡¹ç›®(å”¯ä¸€)"
        int gitlab_mirror_id "GitLab Remote Mirror ID"
        string mirror_url "é•œåƒURL(ä¸å«token)"
        string last_update_status "æœ€åæ›´æ–°çŠ¶æ€: finished/failed/started/pending"
        timestamp last_update_at "æœ€åæ›´æ–°æ—¶é—´"
        timestamp last_successful_update_at "æœ€åæˆåŠŸæ›´æ–°æ—¶é—´"
        int consecutive_failures "è¿ç»­å¤±è´¥æ¬¡æ•°"
        string error_message "é”™è¯¯ä¿¡æ¯"
        timestamp created_at
        timestamp updated_at
    }

    SYNC_EVENT {
        int id PK
        int sync_project_id FK
        string event_type "äº‹ä»¶ç±»å‹: push_detected/sync_started/sync_finished/sync_failed/mirror_created/mirror_updated"
        string event_source "äº‹ä»¶æ¥æº: webhook/polling/manual/system"
        string status "çŠ¶æ€: success/failed/running"
        string commit_sha "æäº¤SHA"
        string ref "å¼•ç”¨(åˆ†æ”¯/æ ‡ç­¾)"
        string branch_name "åˆ†æ”¯åç§°"
        int duration_seconds "è€—æ—¶(ç§’)"
        string error_message "é”™è¯¯ä¿¡æ¯"
        json event_data "äº‹ä»¶è¯¦ç»†æ•°æ®"
        timestamp event_time
    }
```

**å®ä½“è¯´æ˜**ï¼š

### 1. **SYNC_PROJECTï¼ˆåŒæ­¥é¡¹ç›®ä¸»è¡¨ï¼‰**
**æ ¸å¿ƒä¸»è¡¨**ï¼Œç®¡ç†éœ€è¦åŒæ­¥çš„é¡¹ç›®ï¼Œä¸åŒ…å«ç‰¹å®šåŒæ­¥æ–¹å¼çš„é…ç½®

**å…³é”®å­—æ®µ**ï¼š
- **project_key**: é¡¹ç›®å”¯ä¸€æ ‡è¯†ï¼ˆæºé¡¹ç›®è·¯å¾„ï¼Œå¦‚ `group1/project-a`ï¼‰
- **sync_method**: åŒæ­¥æ–¹å¼æ ‡è¯†
  - `push_mirror`: Push Mirror æ–¹å¼ï¼ˆMVPï¼‰
  - `pull_mirror`: Pull Mirror æ–¹å¼ï¼ˆæœªæ¥ï¼‰
  - `clone_push`: Clone & Push æ–¹å¼ï¼ˆæœªæ¥ï¼‰
- **sync_status**: åŒæ­¥æµç¨‹çŠ¶æ€
  - `pending`: å¾…å¤„ç†ï¼ˆåˆšå‘ç°ï¼‰
  - `target_created`: ç›®æ ‡é¡¹ç›®å·²åˆ›å»º
  - `mirror_configured`: Mirror å·²é…ç½®
  - `active`: æ­£å¸¸è¿è¡Œ
  - `failed`: å¤±è´¥
- **enabled**: æ˜¯å¦å¯ç”¨åŒæ­¥
- **error_message**: é€šç”¨é”™è¯¯ä¿¡æ¯

**èŒè´£**ï¼š
- ç®¡ç†åŒæ­¥é¡¹ç›®çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
- æ ‡è¯†ä½¿ç”¨çš„åŒæ­¥æ–¹å¼
- è®°å½•é€šç”¨åŒæ­¥çŠ¶æ€
- ä¸å…·ä½“åŒæ­¥æ–¹å¼é…ç½®è§£è€¦

---

### 2. **SOURCE_PROJECT_INFOï¼ˆæºé¡¹ç›®ä¿¡æ¯è¡¨ï¼‰**
**æ‰©å±•è¡¨**ï¼Œå­˜å‚¨ä»æº GitLab åŠ¨æ€æ‹‰å–çš„é¡¹ç›®è¯¦ç»†ä¿¡æ¯

**å…³é”®å­—æ®µ**ï¼š
- **gitlab_project_id**: æº GitLab çš„é¡¹ç›® ID
- **path_with_namespace**: å®Œæ•´è·¯å¾„
- **group_path**: åˆ†ç»„è·¯å¾„
- **archived/empty_repo**: ç”¨äºè¿‡æ»¤å†³ç­–
- **last_activity_at**: åˆ¤æ–­é¡¹ç›®æ´»è·ƒåº¦
- **synced_at**: ä¿¡æ¯æœ€åæ‹‰å–æ—¶é—´

**èŒè´£**ï¼š
- å­˜å‚¨æºé¡¹ç›®è¯¦ç»†ä¿¡æ¯
- å®šæœŸæ›´æ–°ï¼ˆæ¯æ¬¡é¡¹ç›®å‘ç°ä»»åŠ¡ï¼‰
- ç”¨äºè¿‡æ»¤å’Œå†³ç­–

---

### 3. **TARGET_PROJECT_INFOï¼ˆç›®æ ‡é¡¹ç›®ä¿¡æ¯è¡¨ï¼‰**
**æ‰©å±•è¡¨**ï¼Œå­˜å‚¨åœ¨ç›®æ ‡ GitLab åˆ›å»ºçš„é¡¹ç›®ä¿¡æ¯

**å…³é”®å­—æ®µ**ï¼š
- **gitlab_project_id**: ç›®æ ‡ GitLab çš„é¡¹ç›® ID
- **status**: ç›®æ ‡é¡¹ç›®çŠ¶æ€
  - `not_exist`: æœªåˆ›å»º
  - `creating`: åˆ›å»ºä¸­
  - `created`: å·²åˆ›å»ºï¼ˆæœªé…ç½®åŒæ­¥ï¼‰
  - `ready`: å°±ç»ªï¼ˆåŒæ­¥å·²é…ç½®ï¼‰
  - `error`: é”™è¯¯çŠ¶æ€
  - `deleted`: å·²è¢«åˆ é™¤
- **last_checked_at**: æœ€åæ£€æŸ¥æ—¶é—´ï¼ˆç”¨äºéªŒè¯é¡¹ç›®æ˜¯å¦è¿˜å­˜åœ¨ï¼‰
- **error_message**: é”™è¯¯ä¿¡æ¯
- **retry_count**: é‡è¯•æ¬¡æ•°

**èŒè´£**ï¼š
- è®°å½•ç›®æ ‡é¡¹ç›®çŠ¶æ€
- å­˜å‚¨ç›®æ ‡é¡¹ç›® GitLab ID
- è·Ÿè¸ªé¡¹ç›®å­˜åœ¨æ€§å’Œå¥åº·çŠ¶æ€

---

### 4. **PUSH_MIRROR_CONFIGï¼ˆPush Mirror é…ç½®è¡¨ï¼‰**
**åŒæ­¥æ–¹å¼é…ç½®è¡¨**ï¼Œå­˜å‚¨ Push Mirror ç‰¹å®šçš„é…ç½®å’ŒçŠ¶æ€

**å…³é”®å­—æ®µ**ï¼š
- **sync_project_id**: å…³è”çš„åŒæ­¥é¡¹ç›®ï¼ˆå”¯ä¸€å¤–é”®ï¼‰
- **gitlab_mirror_id**: GitLab Remote Mirror IDï¼ˆAPI è¿”å›ï¼‰
- **mirror_url**: é•œåƒ URLï¼ˆä¸å« tokenï¼‰
- **last_update_status**: Mirror æœ€åæ›´æ–°çŠ¶æ€ï¼ˆfinished/failed/started/pendingï¼‰
- **last_update_at**: æœ€åæ›´æ–°æ—¶é—´
- **last_successful_update_at**: æœ€åæˆåŠŸæ›´æ–°æ—¶é—´
- **consecutive_failures**: è¿ç»­å¤±è´¥æ¬¡æ•°ï¼ˆç”¨äºå‘Šè­¦ï¼‰
- **error_message**: Push Mirror ç‰¹å®šçš„é”™è¯¯ä¿¡æ¯

**èŒè´£**ï¼š
- å­˜å‚¨ Push Mirror ç‰¹å®šé…ç½®
- è®°å½• Mirror åŒæ­¥çŠ¶æ€å’Œå†å²
- ä¸ SYNC_PROJECT 1:1 å…³ç³»
- éš”ç¦» Push Mirror ç‰¹å®šå­—æ®µ

**æœªæ¥æ‰©å±•**ï¼š
- å¯æ–°å¢ `PULL_MIRROR_CONFIG` è¡¨ï¼ˆPull Mirror é…ç½®ï¼‰
- å¯æ–°å¢ `CLONE_PUSH_CONFIG` è¡¨ï¼ˆClone & Push é…ç½®ï¼‰
- æ¯ç§åŒæ­¥æ–¹å¼æœ‰è‡ªå·±çš„é…ç½®è¡¨

---

### 5. **SYNC_EVENTï¼ˆåŒæ­¥äº‹ä»¶è¡¨ï¼‰**
**äº‹ä»¶è¡¨**ï¼Œè®°å½•æ‰€æœ‰åŒæ­¥ç›¸å…³äº‹ä»¶

**äº‹ä»¶ç±»å‹**ï¼š
- **push_detected**: æ£€æµ‹åˆ°æ¨é€
- **sync_started**: åŒæ­¥å¼€å§‹
- **sync_finished**: åŒæ­¥å®Œæˆ
- **sync_failed**: åŒæ­¥å¤±è´¥
- **mirror_created**: Mirror åˆ›å»º
- **mirror_updated**: Mirror é…ç½®æ›´æ–°

**èŒè´£**ï¼š
- è®°å½•å®Œæ•´çš„åŒæ­¥äº‹ä»¶æ—¶é—´çº¿
- ç”¨äºç›‘æ§å’Œåˆ†æ
- è®¡ç®—æ¨é€åˆ°åŒæ­¥çš„å»¶è¿Ÿ
- æ•…éšœæ’æŸ¥

---

## å…³ç³»è¯´æ˜

```
SYNC_PROJECT (ä¸»è¡¨ - é€šç”¨åŒæ­¥ç®¡ç†)
    â”œâ”€â”€ SOURCE_PROJECT_INFO (1:1) - æºé¡¹ç›®è¯¦ç»†ä¿¡æ¯
    â”œâ”€â”€ TARGET_PROJECT_INFO (1:1) - ç›®æ ‡é¡¹ç›®ä¿¡æ¯
    â”œâ”€â”€ PUSH_MIRROR_CONFIG (1:0..1) - Push Mirror é…ç½®ï¼ˆå¯é€‰ï¼‰
    â””â”€â”€ SYNC_EVENT (1:N) - åŒæ­¥äº‹ä»¶å†å²
```

**è®¾è®¡ä¼˜åŠ¿**ï¼š

1. **æ”¯æŒå¤šç§åŒæ­¥æ–¹å¼**
   - SYNC_PROJECT ä½¿ç”¨ `sync_method` å­—æ®µæ ‡è¯†åŒæ­¥æ–¹å¼
   - æ¯ç§åŒæ­¥æ–¹å¼æœ‰ç‹¬ç«‹çš„é…ç½®è¡¨ï¼ˆå¦‚ PUSH_MIRROR_CONFIGï¼‰
   - æœªæ¥å¯æ‰©å±•ï¼šPULL_MIRROR_CONFIG, CLONE_PUSH_CONFIG ç­‰
   - çµæ´»åˆ‡æ¢åŒæ­¥æ–¹å¼

2. **æ¸…æ™°çš„èŒè´£åˆ†ç¦»**
   - SYNC_PROJECTï¼šé€šç”¨åŒæ­¥æµç¨‹ç®¡ç†
   - SOURCE_PROJECT_INFOï¼šæºé¡¹ç›®è¯¦ç»†ä¿¡æ¯ï¼ˆå®šæœŸæ›´æ–°ï¼‰
   - TARGET_PROJECT_INFOï¼šç›®æ ‡é¡¹ç›®ä¿¡æ¯ï¼ˆçŠ¶æ€è·Ÿè¸ªï¼‰
   - PUSH_MIRROR_CONFIGï¼šPush Mirror ç‰¹å®šé…ç½®å’ŒçŠ¶æ€
   - SYNC_EVENTï¼šäº‹ä»¶å†å²ï¼ˆä»…è¿½åŠ ï¼‰

3. **è‰¯å¥½çš„æ‰©å±•æ€§**
   - æ–°å¢åŒæ­¥æ–¹å¼åªéœ€æ·»åŠ æ–°çš„é…ç½®è¡¨
   - ä¸»è¡¨ç»“æ„ä¿æŒç¨³å®š
   - ä¸åŒåŒæ­¥æ–¹å¼å¯ä»¥æœ‰å„è‡ªçš„å­—æ®µ
   - é¿å…ä¸»è¡¨å­—æ®µè†¨èƒ€

4. **æ•°æ®éš”ç¦»å’Œç»´æŠ¤**
   - Push Mirror ç‰¹å®šå­—æ®µéš”ç¦»åœ¨ PUSH_MIRROR_CONFIG
   - ä¾¿äºé’ˆå¯¹ä¸åŒåŒæ­¥æ–¹å¼ä¼˜åŒ–å’Œç»´æŠ¤
   - æŸ¥è¯¢æ€§èƒ½ï¼šæŒ‰éœ€ JOIN é…ç½®è¡¨

---

## ğŸ”„ å…³é”®å¤„ç†æµç¨‹

### æµç¨‹ 1: é¡¹ç›®å‘ç°å’Œ Mirror é…ç½®

```mermaid
graph TD
    A[å®šæ—¶ä»»åŠ¡å¯åŠ¨] --> B[åŠ è½½é…ç½®æ–‡ä»¶]
    B --> C[åŠ¨æ€æ‹‰å–æºåˆ†ç»„åˆ—è¡¨]
    C --> D[éå†åˆ†ç»„æ‹‰å–é¡¹ç›®åˆ—è¡¨]
    D --> E[åº”ç”¨è¿‡æ»¤è§„åˆ™]
    E --> F{é¡¹ç›®å·²å­˜åœ¨æ˜ å°„?}
    F -->|å¦| G[åˆ›å»ºç›®æ ‡åˆ†ç»„]
    G --> H[åˆ›å»ºç›®æ ‡é¡¹ç›®]
    H --> I[é…ç½® Push Mirror]
    I --> J[ä¿å­˜æ˜ å°„å…³ç³»]
    F -->|æ˜¯| K{Mirror å·²é…ç½®?}
    K -->|å¦| I
    K -->|æ˜¯| L[è·³è¿‡]
    J --> M[æ›´æ–°æºé¡¹ç›®ä¿¡æ¯]
    L --> M
    M --> N{è¿˜æœ‰é¡¹ç›®?}
    N -->|æ˜¯| F
    N -->|å¦| O[å®Œæˆ]

    style C fill:#FFD700
    style I fill:#FFB6C1
    style M fill:#90EE90
```

**è¯´æ˜**ï¼š
- **åŠ¨æ€æ‹‰å–**: å®šæ—¶ä»æº GitLab æ‹‰å–æœ€æ–°åˆ†ç»„å’Œé¡¹ç›®ä¿¡æ¯
- **å¢é‡å¤„ç†**: ä»…ä¸ºæ–°é¡¹ç›®åˆ›å»ºç›®æ ‡é¡¹ç›®å’Œé…ç½® Mirror
- **å¹‚ç­‰æ“ä½œ**: å·²é…ç½®çš„ Mirror ä¸ä¼šé‡å¤åˆ›å»º
- **æŒä¹…åŒ–**: æ‰€æœ‰ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“

---

### æµç¨‹ 2: Mirror çŠ¶æ€ç›‘æ§ï¼ˆè½®è¯¢ï¼‰

```mermaid
graph TD
    A[å®šæ—¶è½®è¯¢ä»»åŠ¡] --> B[æŸ¥è¯¢æ‰€æœ‰å·²é…ç½®çš„ Mirror]
    B --> C[æ‰¹é‡è°ƒç”¨ GitLab API è·å– Mirror çŠ¶æ€]
    C --> D{å¯¹æ¯”æ•°æ®åº“çŠ¶æ€}
    D -->|çŠ¶æ€å˜åŒ–| E[è®°å½•åŒæ­¥äº‹ä»¶]
    D -->|æ— å˜åŒ–| F[è·³è¿‡]
    E --> G[æ›´æ–° Mirror çŠ¶æ€]
    F --> H{è¿˜æœ‰ Mirror?}
    G --> H
    H -->|æ˜¯| C
    H -->|å¦| I[å®Œæˆæœ¬è½®è½®è¯¢]

    style C fill:#87CEEB
    style E fill:#90EE90
```

**è¯´æ˜**ï¼š
- **å®šæ—¶è½®è¯¢**: æ¯éš”ä¸€å®šæ—¶é—´ï¼ˆå¦‚ 30 ç§’ï¼‰è½®è¯¢ä¸€æ¬¡
- **æ‰¹é‡æŸ¥è¯¢**: æ‰¹é‡è·å– Mirror çŠ¶æ€ï¼Œå‡å°‘ API è°ƒç”¨
- **çŠ¶æ€å˜åŒ–æ£€æµ‹**: å¯¹æ¯”æ•°æ®åº“è®°å½•ï¼Œä»…è®°å½•å˜åŒ–çš„äº‹ä»¶
- **äº‹ä»¶è®°å½•**: è®°å½• sync_startedã€sync_finishedã€sync_failed ç­‰äº‹ä»¶

---

### æµç¨‹ 3: Webhook äº‹ä»¶æ¥æ”¶ï¼ˆå¯é€‰ï¼‰

```mermaid
graph TD
    A[GitLab Push Event] --> B[Webhook æ¥æ”¶]
    B --> C[éªŒè¯ç­¾å]
    C --> D[è§£æäº‹ä»¶è½½è·]
    D --> E[æŸ¥æ‰¾å¯¹åº”çš„ Mirror]
    E --> F{æ‰¾åˆ° Mirror?}
    F -->|æ˜¯| G[è®°å½• push_detected äº‹ä»¶]
    F -->|å¦| H[å¿½ç•¥]
    G --> I[ç­‰å¾…è½®è¯¢ç¡®è®¤åŒæ­¥çŠ¶æ€]

    style B fill:#FFD700
    style G fill:#90EE90
```

**è¯´æ˜**ï¼š
- **Webhook**: æ¥æ”¶æº GitLab çš„ Push äº‹ä»¶
- **äº‹ä»¶è®°å½•**: è®°å½•æ¨é€äº‹ä»¶ï¼Œç”¨äºè¿½è¸ª
- **è¢«åŠ¨ç›‘æ§**: ä¸ä¸»åŠ¨è§¦å‘åŒæ­¥ï¼Œç­‰å¾…è½®è¯¢ç¡®è®¤ Mirror åŒæ­¥ç»“æœ

---

### æµç¨‹ 4: åŒæ­¥äº‹ä»¶åˆ†æ

```mermaid
graph TD
    A[æŸ¥è¯¢åŒæ­¥äº‹ä»¶] --> B{äº‹ä»¶ç±»å‹}
    B -->|push_detected| C[æ˜¾ç¤ºæ¨é€ä¿¡æ¯]
    B -->|sync_finished| D[æ˜¾ç¤ºåŒæ­¥æˆåŠŸ]
    B -->|sync_failed| E[æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯]
    C --> F[è®¡ç®—æ¨é€åˆ°åŒæ­¥çš„å»¶è¿Ÿ]
    D --> G[è®¡ç®—åŒæ­¥è€—æ—¶]
    E --> H[æä¾›ä¿®å¤å»ºè®®]

    style D fill:#90EE90
    style E fill:#FFB6C1
```

**è¯´æ˜**ï¼š
- **äº‹ä»¶å…³è”**: å…³è” push å’Œ sync äº‹ä»¶ï¼Œåˆ†æåŒæ­¥å»¶è¿Ÿ
- **æ€§èƒ½åˆ†æ**: ç»Ÿè®¡åŒæ­¥è€—æ—¶
- **æ•…éšœåˆ†æ**: åˆ†æå¤±è´¥åŸå› ï¼Œæä¾›å»ºè®®

---

## ğŸŒ REST API è®¾è®¡

### API ç«¯ç‚¹åˆ—è¡¨

#### 1. æœåŠ¡çŠ¶æ€

**è·å–æœåŠ¡çŠ¶æ€**
- **ç«¯ç‚¹**: GET /api/status
- **è®¤è¯**: éœ€è¦ API Token
- **å“åº”**: æœåŠ¡è¿è¡ŒçŠ¶æ€ã€é…ç½®åŠ è½½çŠ¶æ€ã€å®šæ—¶ä»»åŠ¡çŠ¶æ€ã€æ•´ä½“ç»Ÿè®¡

**é‡æ–°åŠ è½½é…ç½®**
- **ç«¯ç‚¹**: POST /api/reload
- **è®¤è¯**: éœ€è¦ API Token
- **å“åº”**: é…ç½®é‡æ–°åŠ è½½ç»“æœ

---

#### 2. åŒæ­¥é¡¹ç›®

**è·å–åŒæ­¥é¡¹ç›®åˆ—è¡¨**
- **ç«¯ç‚¹**: GET /api/projects
- **è®¤è¯**: éœ€è¦ API Token
- **æŸ¥è¯¢å‚æ•°**:
  - sync_status: åŒæ­¥çŠ¶æ€è¿‡æ»¤ï¼ˆpending/active/failedï¼‰
  - enabled: æ˜¯å¦å¯ç”¨
  - page, per_page: åˆ†é¡µ
- **å“åº”**: åŒæ­¥é¡¹ç›®åˆ—è¡¨ï¼ˆå«æºé¡¹ç›®ä¿¡æ¯ã€ç›®æ ‡é¡¹ç›®ä¿¡æ¯ã€Mirror çŠ¶æ€ï¼‰

**è·å–é¡¹ç›®è¯¦æƒ…**
- **ç«¯ç‚¹**: GET /api/projects/:project_key
- **è®¤è¯**: éœ€è¦ API Token
- **å“åº”**:
  - åŒæ­¥é¡¹ç›®åŸºæœ¬ä¿¡æ¯
  - æºé¡¹ç›®è¯¦ç»†ä¿¡æ¯
  - ç›®æ ‡é¡¹ç›®ä¿¡æ¯
  - Mirror é…ç½®å’ŒçŠ¶æ€
  - æœ€è¿‘åŒæ­¥äº‹ä»¶

**æ‰‹åŠ¨è§¦å‘é¡¹ç›®å‘ç°**
- **ç«¯ç‚¹**: POST /api/projects/discover
- **è®¤è¯**: éœ€è¦ API Token
- **å“åº”**: æ–°å‘ç°çš„é¡¹ç›®æ•°é‡ã€åˆ›å»ºçš„é¡¹ç›®æ•°é‡

**é‡æ–°é…ç½®é¡¹ç›® Mirror**
- **ç«¯ç‚¹**: POST /api/projects/:project_key/setup-mirror
- **è®¤è¯**: éœ€è¦ API Token
- **å“åº”**: Mirror é…ç½®ç»“æœ

---

#### 3. Mirror çŠ¶æ€

**è·å– Mirror åˆ—è¡¨**
- **ç«¯ç‚¹**: GET /api/mirrors
- **è®¤è¯**: éœ€è¦ API Token
- **æŸ¥è¯¢å‚æ•°**:
  - status: Mirror çŠ¶æ€è¿‡æ»¤ï¼ˆactive/failedï¼‰
  - last_update_status: æœ€åæ›´æ–°çŠ¶æ€ï¼ˆfinished/failedï¼‰
  - page, per_page: åˆ†é¡µ
- **å“åº”**: Mirror åˆ—è¡¨åŠçŠ¶æ€

**è·å– Mirror ä¸€è‡´æ€§æ£€æŸ¥**
- **ç«¯ç‚¹**: GET /api/mirrors/:project_key/consistency
- **è®¤è¯**: éœ€è¦ API Token
- **å“åº”**:
  - æºä»“åº“åˆ†æ”¯æ•°ã€commit æ•°
  - ç›®æ ‡ä»“åº“åˆ†æ”¯æ•°ã€commit æ•°
  - é»˜è®¤åˆ†æ”¯æœ€å commit SHA å¯¹æ¯”
  - ä¸€è‡´æ€§çŠ¶æ€

**æ‰‹åŠ¨è§¦å‘è½®è¯¢**
- **ç«¯ç‚¹**: POST /api/mirrors/poll
- **è®¤è¯**: éœ€è¦ API Token
- **å“åº”**: è½®è¯¢çš„ Mirror æ•°é‡ã€çŠ¶æ€æ›´æ–°æ•°é‡

---

#### 4. åŒæ­¥äº‹ä»¶

**è·å–äº‹ä»¶åˆ—è¡¨**
- **ç«¯ç‚¹**: GET /api/events
- **è®¤è¯**: éœ€è¦ API Token
- **æŸ¥è¯¢å‚æ•°**:
  - project_key: é¡¹ç›®è¿‡æ»¤
  - event_type: äº‹ä»¶ç±»å‹è¿‡æ»¤
  - status: çŠ¶æ€è¿‡æ»¤
  - start_time, end_time: æ—¶é—´èŒƒå›´
  - page, per_page: åˆ†é¡µ
- **å“åº”**: åŒæ­¥äº‹ä»¶åˆ—è¡¨

**Webhook æ¥æ”¶ç«¯ç‚¹**ï¼ˆå¯é€‰ï¼‰
- **ç«¯ç‚¹**: POST /api/webhooks/push
- **è®¤è¯**: Webhook Secret éªŒè¯
- **è¯·æ±‚ä½“**: GitLab Push Event
- **å“åº”**: æ¥æ”¶ç¡®è®¤

---

#### 5. ç»Ÿè®¡

**è·å–æ•´ä½“ç»Ÿè®¡**
- **ç«¯ç‚¹**: GET /api/stats
- **è®¤è¯**: éœ€è¦ API Token
- **å“åº”**:
  - æ€»é¡¹ç›®æ•°
  - åŒæ­¥çŠ¶æ€åˆ†å¸ƒï¼ˆpending/active/failedï¼‰
  - Mirror çŠ¶æ€åˆ†å¸ƒ
  - æœ€è¿‘åŒæ­¥ç»Ÿè®¡ï¼ˆ24å°æ—¶å†…ï¼‰
  - å¤±è´¥é¡¹ç›®æ•°é‡

### è®¤è¯æœºåˆ¶

**Token å­˜å‚¨**ï¼š
- CLI å®¢æˆ·ç«¯é…ç½®æ–‡ä»¶ä¸­å­˜å‚¨æœåŠ¡ API Token
- ç¯å¢ƒå˜é‡æ–¹å¼ï¼šGITLAB_MIRROR_API_TOKEN

**Token ä¼ é€’**ï¼š
- HTTP Header: Authorization: Bearer <token>

**Token éªŒè¯**ï¼š
- æœåŠ¡ç«¯éªŒè¯ Token æœ‰æ•ˆæ€§
- æ”¯æŒ Token è¿‡æœŸæ—¶é—´
- æ”¯æŒ Token æƒé™çº§åˆ«ï¼ˆåªè¯»/è¯»å†™ï¼‰

**å®‰å…¨æ€§**ï¼š
- HTTPS é€šä¿¡ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- Token åŠ å¯†å­˜å‚¨ï¼ˆå¯é€‰ï¼‰
- Token å®šæœŸè½®æ¢ï¼ˆå»ºè®®ï¼‰

---

## ğŸ’» CLI å‘½ä»¤è®¾è®¡

### è®¾è®¡åŸåˆ™

**é…ç½®æ–‡ä»¶ä¼˜å…ˆ**ï¼š
- ç”¨æˆ·ç›´æ¥ç¼–è¾‘é…ç½®æ–‡ä»¶
- CLI ä»…ç”¨äºæŸ¥çœ‹çŠ¶æ€å’Œæ‰‹åŠ¨æ“ä½œ
- æœåŠ¡è‡ªåŠ¨è¿è¡Œï¼ŒåŠ¨æ€æ‹‰å–é¡¹ç›®

**æ ¸å¿ƒç†å¿µ**ï¼š
```
ä¿®æ”¹é…ç½®æ–‡ä»¶ â†’ æœåŠ¡è‡ªåŠ¨å‘ç°é¡¹ç›®å’Œé…ç½® Mirror â†’ CLI ç›‘æ§çŠ¶æ€å’Œäº‹ä»¶
```

---

### æ ¸å¿ƒå‘½ä»¤

#### 1. æœåŠ¡ç®¡ç†

**å¯åŠ¨æœåŠ¡**
```bash
gitlab-mirror-service start
```
- å¯åŠ¨åŒæ­¥æœåŠ¡
- åŠ è½½é…ç½®æ–‡ä»¶
- å¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼ˆé¡¹ç›®å‘ç°ã€Mirror è½®è¯¢ï¼‰

**åœæ­¢æœåŠ¡**
```bash
gitlab-mirror-service stop
```
- åœæ­¢åŒæ­¥æœåŠ¡
- åœæ­¢æ‰€æœ‰å®šæ—¶ä»»åŠ¡

**æŸ¥çœ‹æœåŠ¡çŠ¶æ€**
```bash
gitlab-mirror-service status
```
- æ˜¾ç¤ºæœåŠ¡è¿è¡ŒçŠ¶æ€
- æ˜¾ç¤ºé…ç½®æ–‡ä»¶è·¯å¾„
- æ˜¾ç¤ºå®šæ—¶ä»»åŠ¡çŠ¶æ€

**é‡æ–°åŠ è½½é…ç½®**
```bash
gitlab-mirror-service reload
```
- é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶
- ä¸ä¸­æ–­æœåŠ¡è¿è¡Œ

---

#### 2. ç›‘æ§çŠ¶æ€

**æŸ¥çœ‹æ•´ä½“æ¦‚è§ˆ**
```bash
gitlab-mirror status
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GitLab Mirror ç›‘æ§é¢æ¿                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æœåŠ¡çŠ¶æ€: âœ… è¿è¡Œä¸­                                         â”‚
â”‚ é…ç½®æ–‡ä»¶: /etc/gitlab-mirror/config.yml                    â”‚
â”‚ ä¸Šæ¬¡æ‹‰å–é¡¹ç›®: 2025-12-13 10:30:00 (5 åˆ†é’Ÿå‰)               â”‚
â”‚ ä¸Šæ¬¡è½®è¯¢ Mirror: 2025-12-13 10:35:30 (30 ç§’å‰)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Mirror ç»Ÿè®¡ï¼š
  æ€»é¡¹ç›®æ•°: 142
  æ€» Mirror æ•°: 140
  âœ… Active: 135 (96.4%)
  âŒ Failed: 5 (3.6%)

æœ€è¿‘åŒæ­¥äº‹ä»¶ (æœ€è¿‘ 10 æ¡):
  âœ… group1/project-a  sync_finished  (2 åˆ†é’Ÿå‰, è€—æ—¶ 15s)
  âœ… group1/project-b  sync_finished  (3 åˆ†é’Ÿå‰, è€—æ—¶ 22s)
  âŒ group2/project-x  sync_failed    (5 åˆ†é’Ÿå‰, é”™è¯¯: permission denied)
  ğŸ”„ group2/large-repo sync_started   (5 åˆ†é’Ÿå‰)

å¤±è´¥ Mirror (5):
  âŒ group2/project-x: æƒé™æ‹’ç»
  âŒ group3/project-y: ç½‘ç»œè¶…æ—¶
  âŒ group4/project-z: Mirror é…ç½®é”™è¯¯

æç¤ºï¼šä½¿ç”¨ 'gitlab-mirror mirrors --failed' æŸ¥çœ‹å¤±è´¥è¯¦æƒ…
```

**é€‰é¡¹**ï¼š
- --refresh <seconds>ï¼šè‡ªåŠ¨åˆ·æ–°ï¼ˆå®æ—¶ç›‘æ§ï¼‰

---

**æŸ¥çœ‹ Mirror åˆ—è¡¨**
```bash
gitlab-mirror mirrors
```

**åŠŸèƒ½**ï¼š
- æ˜¾ç¤ºæ‰€æœ‰ Mirror çŠ¶æ€åˆ—è¡¨

**é€‰é¡¹**ï¼š
- --failedï¼šä»…æ˜¾ç¤ºå¤±è´¥çš„ Mirror
- --activeï¼šä»…æ˜¾ç¤ºæ´»è·ƒçš„ Mirror
- --project <path>ï¼šè¿‡æ»¤ç‰¹å®šé¡¹ç›®

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
Mirror åˆ—è¡¨ (æ€»è®¡: 140)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¡¹ç›®è·¯å¾„                   â”‚ çŠ¶æ€      â”‚ æœ€åæ›´æ–°çŠ¶æ€     â”‚ æœ€åæ›´æ–°æ—¶é—´    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ group1/project-a           â”‚ âœ… Active â”‚ finished         â”‚ 2åˆ†é’Ÿå‰         â”‚
â”‚ group1/project-b           â”‚ âœ… Active â”‚ finished         â”‚ 3åˆ†é’Ÿå‰         â”‚
â”‚ group2/project-x           â”‚ âŒ Failed â”‚ failed           â”‚ 5åˆ†é’Ÿå‰         â”‚
â”‚ group2/large-repo          â”‚ âœ… Active â”‚ started          â”‚ 5åˆ†é’Ÿå‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**æŸ¥çœ‹ Mirror è¯¦æƒ…**
```bash
gitlab-mirror mirror <project_path>
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
é¡¹ç›®: group2/project-x

åŸºæœ¬ä¿¡æ¯ï¼š
  æºé¡¹ç›® ID: 12345
  æºé¡¹ç›®è·¯å¾„: group2/project-x
  ç›®æ ‡é¡¹ç›® ID: 67890
  ç›®æ ‡é¡¹ç›®è·¯å¾„: group2/project-x

Mirror é…ç½®ï¼š
  GitLab Mirror ID: 156
  çŠ¶æ€: âŒ Failed
  å¯ç”¨: æ˜¯
  æœ€åæ›´æ–°çŠ¶æ€: failed
  æœ€åæ›´æ–°æ—¶é—´: 2025-12-13 10:25:00
  æœ€åæˆåŠŸæ›´æ–°: 2025-12-13 09:15:00
  é”™è¯¯ä¿¡æ¯: Target repository permission denied

ä¸€è‡´æ€§æ£€æŸ¥ï¼š
  æºä»“åº“åˆ†æ”¯æ•°: 5
  ç›®æ ‡ä»“åº“åˆ†æ”¯æ•°: 4
  æºä»“åº“æœ€å commit: a1b2c3d (2025-12-13 10:30:00)
  ç›®æ ‡ä»“åº“æœ€å commit: e4f5g6h (2025-12-13 09:15:00)
  âš ï¸ ä¸ä¸€è‡´

æœ€è¿‘åŒæ­¥äº‹ä»¶ (æœ€è¿‘ 5 æ¡):
  2025-12-13 10:30:00  push_detected  (SHA: a1b2c3d, ref: main)
  2025-12-13 10:25:00  sync_failed    (é”™è¯¯: permission denied)
  2025-12-13 09:20:00  push_detected  (SHA: h7i8j9k, ref: main)
  2025-12-13 09:15:30  sync_finished  (è€—æ—¶: 15s)
  2025-12-13 09:15:15  sync_started

å»ºè®®æ“ä½œï¼š
  1. æ£€æŸ¥ç›®æ ‡é¡¹ç›®æƒé™
  2. è¿è¡Œ: gitlab-mirror mirror group2/project-x --setup é‡æ–°é…ç½®
```

**é€‰é¡¹**ï¼š
- --consistencyï¼šæ£€æŸ¥æºå’Œç›®æ ‡ä»“åº“ä¸€è‡´æ€§

---

**æŸ¥çœ‹åŒæ­¥äº‹ä»¶**
```bash
gitlab-mirror events
```

**åŠŸèƒ½**ï¼š
- æŸ¥çœ‹æœ€è¿‘çš„åŒæ­¥äº‹ä»¶

**é€‰é¡¹**ï¼š
- --project <path>ï¼šè¿‡æ»¤ç‰¹å®šé¡¹ç›®
- --type <event_type>ï¼šè¿‡æ»¤äº‹ä»¶ç±»å‹
- --failedï¼šä»…æ˜¾ç¤ºå¤±è´¥äº‹ä»¶
- --limit <N>ï¼šé™åˆ¶æ˜¾ç¤ºæ•°é‡

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
åŒæ­¥äº‹ä»¶åˆ—è¡¨ (æœ€è¿‘ 20 æ¡)

æ—¶é—´                    é¡¹ç›®                   äº‹ä»¶ç±»å‹         çŠ¶æ€     è¯¦æƒ…
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2025-12-13 10:35:00     group1/project-a      sync_finished    æˆåŠŸ     è€—æ—¶ 15s
2025-12-13 10:34:45     group1/project-a      sync_started     -        -
2025-12-13 10:34:30     group1/project-a      push_detected    -        SHA: a1b2c3d
2025-12-13 10:30:00     group2/project-x      sync_failed      å¤±è´¥     permission denied
2025-12-13 10:29:45     group2/project-x      sync_started     -        -
```

---

#### 3. é¡¹ç›®ç®¡ç†

**æŸ¥çœ‹æºé¡¹ç›®åˆ—è¡¨**
```bash
gitlab-mirror projects
```

**åŠŸèƒ½**ï¼š
- æ˜¾ç¤ºä»æº GitLab åŠ¨æ€æ‹‰å–çš„é¡¹ç›®åˆ—è¡¨

**é€‰é¡¹**ï¼š
- --group <path>ï¼šè¿‡æ»¤ç‰¹å®šåˆ†ç»„
- --no-mirrorï¼šä»…æ˜¾ç¤ºæœªé…ç½® Mirror çš„é¡¹ç›®

---

**æ‰‹åŠ¨è§¦å‘é¡¹ç›®å‘ç°**
```bash
gitlab-mirror discover
```

**åŠŸèƒ½**ï¼š
- ç«‹å³ä»æº GitLab æ‹‰å–æœ€æ–°é¡¹ç›®åˆ—è¡¨
- ä¸ºæ–°é¡¹ç›®é…ç½® Mirror

---

**ä¸ºé¡¹ç›®é…ç½® Mirror**
```bash
gitlab-mirror mirror <project_path> --setup
```

**åŠŸèƒ½**ï¼š
- ä¸ºæŒ‡å®šé¡¹ç›®æ‰‹åŠ¨é…ç½® Mirror
- ç”¨äºé‡è¯•å¤±è´¥çš„é…ç½®

---

#### 4. å…¶ä»–å·¥å…·

**å¯¼å‡ºæ•°æ®**
```bash
gitlab-mirror export --format json --output mirrors.json
```

**åŠŸèƒ½**ï¼š
- å¯¼å‡º Mirror çŠ¶æ€æ•°æ®
- å¯¼å‡ºåŒæ­¥äº‹ä»¶æ•°æ®

**é€‰é¡¹**ï¼š
- --type: mirrors/events/all
- --format: json/csv
- --output: è¾“å‡ºæ–‡ä»¶è·¯å¾„

---

### ç®€åŒ–ä½¿ç”¨æµç¨‹

**é¦–æ¬¡ä½¿ç”¨**ï¼š
```bash
# 1. ç¼–è¾‘é…ç½®æ–‡ä»¶
vi /etc/gitlab-mirror/config.yml

# 2. å¯åŠ¨æœåŠ¡ï¼ˆè‡ªåŠ¨æ‹‰å–é¡¹ç›®å’Œé…ç½® Mirrorï¼‰
gitlab-mirror-service start

# 3. æŸ¥çœ‹çŠ¶æ€
gitlab-mirror status
```

**æ—¥å¸¸ä½¿ç”¨**ï¼š
```bash
# æœåŠ¡è‡ªåŠ¨è¿è¡Œï¼Œä»…éœ€æŸ¥çœ‹çŠ¶æ€
gitlab-mirror status

# æˆ–å®æ—¶ç›‘æ§
gitlab-mirror status --refresh 10
```

**å¤„ç†é—®é¢˜**ï¼š
```bash
# 1. æŸ¥çœ‹å¤±è´¥çš„ Mirror
gitlab-mirror mirrors --failed

# 2. æŸ¥çœ‹è¯¦æƒ…
gitlab-mirror mirror group2/project-x

# 3. ä¿®å¤é—®é¢˜åé‡æ–°é…ç½®
gitlab-mirror mirror group2/project-x --setup
```

---

## ğŸ“Š é…ç½®æ–‡ä»¶æ ¼å¼

### é…ç½®æ–‡ä»¶è·¯å¾„

**é»˜è®¤è·¯å¾„**: /etc/gitlab-mirror/config.yml

**ç¯å¢ƒå˜é‡**: GITLAB_MIRROR_CONFIG

### å®Œæ•´é…ç½®ç¤ºä¾‹

```yaml
# GitLab æºå’Œç›®æ ‡é…ç½®
source:
  url: https://source.gitlab.com
  token: ${SOURCE_GITLAB_TOKEN}  # ç¯å¢ƒå˜é‡

target:
  url: https://target.gitlab.com
  token: ${TARGET_GITLAB_TOKEN}  # ç¯å¢ƒå˜é‡

# åŒæ­¥é…ç½®ï¼ˆåŠ¨æ€æ‹‰å–ï¼‰
sync:
  # åŒ…å«çš„åˆ†ç»„è·¯å¾„ï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰
  include_groups:
    - "group1/**"           # åŒ…å« group1 åŠæ‰€æœ‰å­åˆ†ç»„
    - "group2/subgroup"     # ä»…åŒ…å«ç‰¹å®šå­åˆ†ç»„
    - "group3"              # åŒ…å« group3ï¼ˆä¸å«å­åˆ†ç»„ï¼‰

  # æ’é™¤çš„åˆ†ç»„è·¯å¾„
  exclude_groups:
    - "group1/archived/**"
    - "*/test-*"            # æ’é™¤æ‰€æœ‰ test- å¼€å¤´çš„åˆ†ç»„

  # é¡¹ç›®è¿‡æ»¤è§„åˆ™
  filters:
    exclude_archived: true  # æ’é™¤å½’æ¡£é¡¹ç›®
    exclude_empty: true     # æ’é™¤ç©ºä»“åº“
    min_activity_days: 30   # æ’é™¤è¶…è¿‡30å¤©æ— æ´»åŠ¨çš„é¡¹ç›®ï¼ˆå¯é€‰ï¼‰

  # Push Mirror é…ç½®é€‰é¡¹
  mirror:
    enabled: true

# å®šæ—¶ä»»åŠ¡é…ç½®
scheduler:
  # é¡¹ç›®å‘ç°ä»»åŠ¡ï¼ˆæ‹‰å–æ–°é¡¹ç›®ï¼‰
  project_discovery:
    enabled: true
    interval: 300  # é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 5 åˆ†é’Ÿ

  # Mirror çŠ¶æ€è½®è¯¢ä»»åŠ¡
  mirror_polling:
    enabled: true
    interval: 30   # é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 30 ç§’

  # ä¸€è‡´æ€§æ£€æŸ¥ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰
  consistency_check:
    enabled: false
    interval: 3600  # é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 1 å°æ—¶

# Webhook é…ç½®ï¼ˆå¯é€‰ï¼‰
webhook:
  enabled: false
  port: 9000
  path: /webhooks/gitlab
  secret: ${WEBHOOK_SECRET}  # Webhook éªŒè¯å¯†é’¥

# æ•°æ®åº“é…ç½®
database:
  type: sqlite
  path: /var/lib/gitlab-mirror/data.db
  backup:
    enabled: true
    interval: 86400  # æ¯å¤©å¤‡ä»½
    keep_days: 7     # ä¿ç•™ 7 å¤©

# æ—¥å¿—é…ç½®
logging:
  level: INFO  # DEBUG, INFO, WARN, ERROR
  file: /var/log/gitlab-mirror/service.log
  format: json  # json æˆ– text
  rotation:
    max_size: 100  # MB
    max_files: 10

# API æœåŠ¡é…ç½®
api:
  host: 0.0.0.0
  port: 8080
  auth:
    enabled: true
    tokens:
      - ${API_TOKEN_1}  # CLI ä½¿ç”¨çš„ API Token
      - ${API_TOKEN_2}  # å¯é€‰çš„ç¬¬äºŒä¸ª Token

# æ€§èƒ½é…ç½®
performance:
  project_discovery_concurrency: 5   # é¡¹ç›®å‘ç°å¹¶å‘æ•°
  mirror_setup_concurrency: 10       # Mirror é…ç½®å¹¶å‘æ•°
  mirror_polling_batch_size: 50      # Mirror è½®è¯¢æ‰¹æ¬¡å¤§å°
  api_rate_limit_delay: 0.1          # API é™æµå»¶è¿Ÿï¼ˆç§’ï¼‰
```

### æœ€å°é…ç½®ç¤ºä¾‹

```yaml
# æœ€å°é…ç½®ï¼ˆä»…å¿…éœ€å­—æ®µï¼‰
source:
  url: https://source.gitlab.com
  token: ${SOURCE_GITLAB_TOKEN}

target:
  url: https://target.gitlab.com
  token: ${TARGET_GITLAB_TOKEN}

sync:
  include_groups:
    - "**"  # åŒ…å«æ‰€æœ‰åˆ†ç»„
```

### é…ç½®è¯´æ˜

#### 1. GitLab é…ç½®
- **source/target.url**: GitLab å®ä¾‹ URL
- **source/target.token**: è®¿é—® Tokenï¼ˆéœ€è¦ apiã€read_repositoryã€write_repository æƒé™ï¼‰

#### 2. åŒæ­¥é…ç½®
- **include_groups**: åŒ…å«çš„åˆ†ç»„è·¯å¾„ï¼ˆæ”¯æŒ `**` é€šé…ç¬¦è¡¨ç¤ºé€’å½’ï¼‰
- **exclude_groups**: æ’é™¤çš„åˆ†ç»„è·¯å¾„ï¼ˆä¼˜å…ˆçº§é«˜äº includeï¼‰
- **filters**: é¡¹ç›®è¿‡æ»¤è§„åˆ™ï¼ˆåŠ¨æ€åº”ç”¨ï¼‰
- **mirror**: Push Mirror é…ç½®é€‰é¡¹

#### 3. å®šæ—¶ä»»åŠ¡é…ç½®
- **project_discovery**: å®šæ—¶ä»æº GitLab æ‹‰å–é¡¹ç›®åˆ—è¡¨
- **mirror_polling**: å®šæ—¶è½®è¯¢ Mirror çŠ¶æ€
- **consistency_check**: å®šæ—¶æ£€æŸ¥æºå’Œç›®æ ‡ä»“åº“ä¸€è‡´æ€§ï¼ˆå¯é€‰ï¼‰

#### 4. Webhook é…ç½®ï¼ˆå¯é€‰ï¼‰
- å¯ç”¨åå¯æ¥æ”¶æº GitLab çš„ Push äº‹ä»¶
- ç”¨äºå®æ—¶è®°å½•æ¨é€äº‹ä»¶

#### 5. æ€§èƒ½é…ç½®
- **concurrency**: å¹¶å‘æ§åˆ¶å‚æ•°
- **batch_size**: æ‰¹é‡å¤„ç†å¤§å°
- **api_rate_limit_delay**: API è°ƒç”¨é—´éš”ï¼ˆé¿å…é™æµï¼‰

---

---

## ğŸ“ æ—¥å¿—è®¾è®¡

### æ—¥å¿—å±‚æ¬¡

**ä¸‰å±‚æ—¥å¿—ç²’åº¦**ï¼š
1. **ä»»åŠ¡çº§åˆ«**ï¼šæ•´ä½“åŒæ­¥ä»»åŠ¡çš„å¼€å§‹/ç»“æŸã€æ€»ä½“ç»“æœ
2. **é˜¶æ®µçº§åˆ«**ï¼šé¡¹ç›®å‘ç°ã€åˆ†ç»„åˆ›å»ºã€Mirror é…ç½®ã€åŒæ­¥ç›‘æ§ç­‰é˜¶æ®µ
3. **æ“ä½œçº§åˆ«**ï¼šæ¯ä¸ªé¡¹ç›®çš„ Mirror åˆ›å»ºã€åŒæ­¥çŠ¶æ€æŸ¥è¯¢ç­‰æ“ä½œ

### æ—¥å¿—æ ¼å¼

**JSON ç»“æ„åŒ–æ—¥å¿—**ï¼š
- æ¯æ¡æ—¥å¿—åŒ…å«ï¼štimestamp, level, event_type, message, details
- event_type åˆ†ç±»ï¼štask_started, mirror_created, mirror_synced, mirror_failed, error ç­‰
- details åŒ…å«ï¼šproject_id, project_path, mirror_id, duration, error ç­‰

### æ—¥å¿—çº§åˆ«
- DEBUGï¼šAPI è°ƒç”¨è¯¦æƒ…ã€è½®è¯¢çŠ¶æ€ã€è¯¦ç»†å‚æ•°
- INFOï¼šMirror åˆ›å»ºã€åŒæ­¥å®Œæˆã€è¿›åº¦æ›´æ–°
- WARNï¼šé‡è¯•ã€è¶…æ—¶è­¦å‘Šã€è·³è¿‡é¡¹ç›®
- ERRORï¼šå¤±è´¥ã€å¼‚å¸¸ã€è‡´å‘½é”™è¯¯

### æ—¥å¿—è¾“å‡º
- æ–‡ä»¶è¾“å‡ºï¼šJSON æ ¼å¼ï¼Œæ”¯æŒæ—¥å¿—è½®è½¬ï¼ˆæŒ‰å¤§å°æˆ–æ—¥æœŸï¼‰
- æ§åˆ¶å°è¾“å‡ºï¼šå½©è‰²æ–‡æœ¬æ ¼å¼ï¼ˆç”¨æˆ·å‹å¥½ï¼‰
- æ—¥å¿—æŸ¥è¯¢ï¼šé€šè¿‡ API æŸ¥è¯¢å’Œè¿‡æ»¤æ—¥å¿—

### æ€§èƒ½åˆ†æ
- è®°å½•æ¯ä¸ªé˜¶æ®µçš„è€—æ—¶
- æ”¯æŒé€šè¿‡æ—¥å¿—åˆ†ææ€§èƒ½ç“¶é¢ˆ
- æä¾›æ€§èƒ½æŠ¥å‘Šç”Ÿæˆå·¥å…·

---

## ğŸ“ˆ ç›‘æ§å’ŒæŠ¥å‘Š

### åŒæ­¥çŠ¶æ€ç›‘æ§

**ç›‘æ§å†…å®¹**ï¼š
- Mirror é…ç½®çŠ¶æ€ï¼ˆå·²é…ç½®/å¤±è´¥ï¼‰
- Mirror åŒæ­¥çŠ¶æ€ï¼ˆåŒæ­¥ä¸­/å·²åŒæ­¥/å¤±è´¥ï¼‰
- æœ€ååŒæ­¥æ—¶é—´
- åŒæ­¥é¢‘ç‡ç»Ÿè®¡
- å¤±è´¥åŸå› åˆ†æ

**ç›‘æ§æ–¹å¼**ï¼š
- CLI æŸ¥è¯¢å‘½ä»¤ï¼ˆå®æ—¶ï¼‰
- çŠ¶æ€æ•°æ®åº“æŸ¥è¯¢
- æ—¥å¿—åˆ†æ
- Web UIï¼ˆå¯é€‰ - P2ï¼‰

### åŒæ­¥æŠ¥å‘Š

**é…ç½®æŠ¥å‘Š**ï¼š
- æ‰§è¡Œæ‘˜è¦ï¼šæ€»é¡¹ç›®æ•°ã€æˆåŠŸé…ç½®æ•°ã€å¤±è´¥æ•°ã€è€—æ—¶
- æˆåŠŸé…ç½®çš„ Mirror åˆ—è¡¨
- å¤±è´¥çš„é¡¹ç›®åˆ—è¡¨åŠåŸå› 
- è·³è¿‡çš„é¡¹ç›®åˆ—è¡¨åŠåŸå› 

**çŠ¶æ€æŠ¥å‘Š**ï¼š
- Mirror åŒæ­¥ç»Ÿè®¡ï¼ˆå·²åŒæ­¥ã€å¤±è´¥ã€åŒæ­¥ä¸­ï¼‰
- æœ€ååŒæ­¥æ—¶é—´ç»Ÿè®¡
- å¤±è´¥ Mirror çš„é”™è¯¯è¯¦æƒ…
- åŒæ­¥é¢‘ç‡åˆ†æ

**æŠ¥å‘Šæ ¼å¼**ï¼š
- çº¯æ–‡æœ¬æ ¼å¼ï¼ˆæ˜“è¯»ï¼‰
- JSON æ ¼å¼ï¼ˆæœºå™¨å¯è¯»ï¼‰
- CSV æ ¼å¼ï¼ˆExcel åˆ†æï¼‰

---

## âš ï¸ é”™è¯¯å¤„ç†

### é”™è¯¯åˆ†ç±»

**è‡´å‘½é”™è¯¯**ï¼ˆåœæ­¢æ‰§è¡Œï¼‰ï¼š
- é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯
- æº/ç›®æ ‡è¿æ¥å¤±è´¥
- API Token è®¤è¯å¤±è´¥
- æœåŠ¡ç«¯ä¸å¯è¾¾

**å¯æ¢å¤é”™è¯¯**ï¼ˆé‡è¯•ï¼‰ï¼š
- ç½‘ç»œè¶…æ—¶
- API é™æµï¼ˆ429ï¼‰
- 5xx æœåŠ¡å™¨é”™è¯¯
- Mirror åŒæ­¥å¤±è´¥

**è­¦å‘Š**ï¼ˆè®°å½•åç»§ç»­ï¼‰ï¼š
- Mirror å·²å­˜åœ¨
- ç›®æ ‡é¡¹ç›®å·²å­˜åœ¨
- é¡¹ç›®è¢«è·³è¿‡ï¼ˆè¿‡æ»¤è§„åˆ™ï¼‰

### é‡è¯•æœºåˆ¶

**é‡è¯•ç­–ç•¥**ï¼š
- æŒ‡æ•°é€€é¿ï¼š1s, 2s, 4s, 8s, 16s
- æœ€å¤§é‡è¯•æ¬¡æ•°ï¼š3 æ¬¡
- é‡è¯•æ¡ä»¶ï¼šç½‘ç»œé”™è¯¯ã€è¶…æ—¶ã€5xxã€429

**API é™æµå¤„ç†**ï¼š
- æ£€æµ‹ 429 å“åº”
- è¯»å– Retry-After Header
- ç­‰å¾…æŒ‡å®šæ—¶é—´åé‡è¯•
- è‡ªåŠ¨è°ƒæ•´å¹¶å‘æ•°

### å¤±è´¥å¤„ç†

**è®°å½•å¤±è´¥**ï¼š
- ä¿å­˜å¤±è´¥é¡¹ç›®åˆ°æ•°æ®åº“
- è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯
- è®°å½•å¤±è´¥æ—¶é—´å’Œé‡è¯•æ¬¡æ•°

**å¤±è´¥æ¢å¤**ï¼š
- æ”¯æŒæ‰‹åŠ¨é‡è¯•å¤±è´¥é¡¹ç›®
- æ”¯æŒé‡æ–°é…ç½® Mirrorï¼ˆåˆ é™¤åé‡å»ºï¼‰
- æ”¯æŒè·³è¿‡å¤±è´¥é¡¹ç›®ç»§ç»­æ‰§è¡Œ

---

## ğŸš€ å…¸å‹ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: é¦–æ¬¡é…ç½®å’Œå¯åŠ¨

**æ­¥éª¤ 1ï¼šç¼–è¾‘é…ç½®æ–‡ä»¶**
```bash
vi /etc/gitlab-mirror/config.yml
```

é…ç½®å†…å®¹ï¼š
```yaml
source:
  url: https://source.gitlab.com
  token: ${SOURCE_GITLAB_TOKEN}

target:
  url: https://target.gitlab.com
  token: ${TARGET_GITLAB_TOKEN}

sync:
  include_groups:
    - "group1/**"
    - "group2/important-projects"
  filters:
    exclude_archived: true
    exclude_empty: true
```

**æ­¥éª¤ 2ï¼šå¯åŠ¨æœåŠ¡**
```bash
gitlab-mirror-service start
```

**è‡ªåŠ¨æ‰§è¡Œæµç¨‹**ï¼š
1. åŠ è½½é…ç½®æ–‡ä»¶
2. è¿æ¥æºå’Œç›®æ ‡ GitLab
3. æ‹‰å–é¡¹ç›®åˆ—è¡¨ï¼Œåˆ›å»º `sync_project` è®°å½•ï¼ˆè®¾ç½® `sync_method='push_mirror'`ï¼‰
4. ä¿å­˜æºé¡¹ç›®ä¿¡æ¯åˆ° `source_project_info`
5. åˆ›å»ºç›®æ ‡é¡¹ç›®ï¼Œä¿å­˜åˆ° `target_project_info`
6. é…ç½® Push Mirrorï¼Œä¿å­˜åˆ° `push_mirror_config`
7. è®°å½•æ‰€æœ‰äº‹ä»¶åˆ° `sync_event`

**æ­¥éª¤ 3ï¼šæŸ¥çœ‹çŠ¶æ€**
```bash
gitlab-mirror status
```

**ç»“æœ**ï¼š
- è‡ªåŠ¨å‘ç°å¹¶é…ç½®äº†æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„é¡¹ç›®
- Push Mirror å¼€å§‹è‡ªåŠ¨åŒæ­¥
- åç»­å®šæ—¶æ‹‰å–æ–°é¡¹ç›®

---

### åœºæ™¯ 2: ç›‘æ§åŒæ­¥çŠ¶æ€

**æŸ¥çœ‹æ•´ä½“æ¦‚è§ˆ**
```bash
gitlab-mirror status
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
- æ€»é¡¹ç›®æ•°: 142ï¼ˆæŸ¥è¯¢ `sync_project` è¡¨ï¼‰
- Active: 135ï¼ˆsync_status = 'active'ï¼‰
- Failed: 5ï¼ˆsync_status = 'failed'ï¼‰
- æœ€è¿‘åŒæ­¥äº‹ä»¶ï¼ˆæŸ¥è¯¢ `sync_event` è¡¨ï¼‰

**æŸ¥çœ‹å¤±è´¥çš„ Mirror**
```bash
gitlab-mirror mirrors --failed
```

**æ•°æ®æ¥æº**ï¼šæŸ¥è¯¢ sync_project å’Œ push_mirror_config è¡¨ï¼Œè¿‡æ»¤ sync_status = 'failed' æˆ– last_update_status = 'failed' çš„è®°å½•

**æŸ¥çœ‹ç‰¹å®šé¡¹ç›®è¯¦æƒ…**
```bash
gitlab-mirror mirror group2/project-x
```

**æ˜¾ç¤ºä¿¡æ¯**ï¼š
- åŸºæœ¬ä¿¡æ¯ï¼ˆæ¥è‡ª `sync_project`ï¼‰
- æºé¡¹ç›®ä¿¡æ¯ï¼ˆæ¥è‡ª `source_project_info`ï¼‰
- ç›®æ ‡é¡¹ç›®ä¿¡æ¯ï¼ˆæ¥è‡ª `target_project_info`ï¼‰
- Push Mirror çŠ¶æ€ï¼ˆæ¥è‡ª `push_mirror_config`ï¼‰
- ä¸€è‡´æ€§æ£€æŸ¥ï¼ˆè°ƒç”¨ GitLab API æ¯”å¯¹ï¼‰
- åŒæ­¥äº‹ä»¶æ—¶é—´çº¿ï¼ˆæ¥è‡ª `sync_event`ï¼‰

---

### åœºæ™¯ 3: å¤„ç†å¤±è´¥é¡¹ç›®

**æ­¥éª¤ 1ï¼šæŸ¥çœ‹å¤±è´¥é¡¹ç›®**
```bash
gitlab-mirror mirrors --failed
```

**æ•°æ®æ¥æº**ï¼šJOIN sync_project å’Œ push_mirror_config è¡¨ï¼ŒæŸ¥æ‰¾ sync_status = 'failed' æˆ– last_update_status = 'failed' çš„é¡¹ç›®

**æ­¥éª¤ 2ï¼šæŸ¥çœ‹è¯¦æƒ…å’Œäº‹ä»¶**
```bash
gitlab-mirror mirror group2/project-x
```

**æ˜¾ç¤ºå†…å®¹**ï¼šé¡¹ç›®è¯¦æƒ…ã€Mirror çŠ¶æ€ã€æœ€è¿‘åŒæ­¥äº‹ä»¶ï¼ˆæŸ¥è¯¢ sync_event è¡¨ï¼‰

**æ­¥éª¤ 3ï¼šé‡æ–°é…ç½®**
```bash
gitlab-mirror mirror group2/project-x --setup
```

**æ‰§è¡Œæ“ä½œ**ï¼š
1. æŸ¥è¯¢ `sync_project` æ‰¾åˆ°é¡¹ç›®
2. åˆ é™¤æ—§çš„ `push_mirror_config` è®°å½•
3. é‡æ–°è°ƒç”¨ GitLab API é…ç½® Mirror
4. åˆ›å»ºæ–°çš„ `push_mirror_config` è®°å½•
5. æ›´æ–° `sync_project.sync_status = 'mirror_configured'`
6. è®°å½• `mirror_created` äº‹ä»¶åˆ° `sync_event`

---

### åœºæ™¯ 4: æ–°é¡¹ç›®è‡ªåŠ¨å‘ç°

**æº GitLab æ–°å¢é¡¹ç›®**
```
ç”¨æˆ·åœ¨æº GitLab åˆ›å»º: group1/new-project
```

**å®šæ—¶ä»»åŠ¡è‡ªåŠ¨å¤„ç†**ï¼ˆ5 åˆ†é’Ÿåï¼‰
```
1. é¡¹ç›®å‘ç°ä»»åŠ¡æ‹‰å–æœ€æ–°é¡¹ç›®åˆ—è¡¨
2. æ£€æŸ¥ sync_project è¡¨æ˜¯å¦å­˜åœ¨ project_key='group1/new-project'
3. ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°è®°å½•:
   INSERT INTO sync_project (project_key, sync_method, sync_status, enabled)
   VALUES ('group1/new-project', 'push_mirror', 'pending', true);

4. ä¿å­˜æºé¡¹ç›®ä¿¡æ¯:
   INSERT INTO source_project_info (sync_project_id, gitlab_project_id, ...)
   VALUES (...);

5. åˆ›å»ºç›®æ ‡é¡¹ç›®ï¼Œä¿å­˜åˆ° target_project_info
6. é…ç½® Mirrorï¼Œä¿å­˜åˆ° push_mirror_config è¡¨
7. è®°å½•æ‰€æœ‰äº‹ä»¶åˆ° sync_event
```

**æŸ¥çœ‹æ–°é¡¹ç›®**
```bash
gitlab-mirror projects --no-mirror
```

**æ•°æ®æ¥æº**ï¼šLEFT JOIN sync_project å’Œ push_mirror_config è¡¨ï¼Œæ‰¾åˆ°æ²¡æœ‰å…³è” push_mirror_config è®°å½•çš„é¡¹ç›®

---

### åœºæ™¯ 5: åˆ†æåŒæ­¥æ€§èƒ½

**æŸ¥çœ‹åŒæ­¥äº‹ä»¶**
```bash
gitlab-mirror events --type sync_finished --limit 100
```

**æ€§èƒ½åˆ†æ**ï¼š
- è®¡ç®—æ¨é€åˆ°åŒæ­¥å®Œæˆçš„å¹³å‡å»¶è¿Ÿï¼ˆå…³è” push_detected å’Œ sync_finished äº‹ä»¶ï¼‰
- ç»Ÿè®¡åŒæ­¥è€—æ—¶åˆ†å¸ƒï¼ˆ<10s, 10s-1m, 1m-5m, >5mï¼‰
- æŸ¥è¯¢é•¿æ—¶é—´æœªåŒæ­¥çš„é¡¹ç›®

---

## ğŸ¯ MVP éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- **é…ç½®ç®¡ç†**ï¼šYAML é…ç½®æ–‡ä»¶æ”¯æŒï¼Œç¯å¢ƒå˜é‡æ”¯æŒï¼Œé…ç½®éªŒè¯
- **è¿æ¥æµ‹è¯•**ï¼šæºå’Œç›®æ ‡ GitLab è¿é€šæ€§æµ‹è¯•ï¼ŒToken æƒé™éªŒè¯
- **é¡¹ç›®å‘ç°**ï¼šæŒ‰åˆ†ç»„è·å–é¡¹ç›®åˆ—è¡¨ï¼Œåº”ç”¨è¿‡æ»¤è§„åˆ™ï¼Œæ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
- **ç›®æ ‡å‡†å¤‡**ï¼šè‡ªåŠ¨åˆ›å»ºåˆ†ç»„å’Œé¡¹ç›®ï¼Œä¿æŒè·¯å¾„ä¸€è‡´ï¼Œå†²çªå¤„ç†
- **Push Mirror é…ç½®**ï¼šæ‰¹é‡é…ç½® Mirrorï¼Œè§¦å‘é¦–æ¬¡åŒæ­¥ï¼Œä¿å­˜ Mirror ID
- **åŒæ­¥ç›‘æ§**ï¼šè½®è¯¢æŸ¥è¯¢ Mirror çŠ¶æ€ï¼Œå®æ—¶æ˜¾ç¤ºè¿›åº¦ï¼Œè¶…æ—¶å¤„ç†
- **çŠ¶æ€ç®¡ç†**ï¼šSQLite æŒä¹…åŒ–ï¼ŒçŠ¶æ€æŸ¥è¯¢ APIï¼Œå¯¼å‡ºæŠ¥å‘Š
- **é”™è¯¯å¤„ç†**ï¼šè‡ªåŠ¨é‡è¯•ï¼Œå¤±è´¥è®°å½•ï¼Œæ‰‹åŠ¨é‡è¯•æ”¯æŒ
- **æ—¥å¿—è®°å½•**ï¼šJSON ç»“æ„åŒ–æ—¥å¿—ï¼Œæ€§èƒ½åˆ†ææ”¯æŒï¼Œæ—¥å¿—æŸ¥è¯¢ API
- **REST API**ï¼šå®Œæ•´çš„ API ç«¯ç‚¹ï¼ŒToken è®¤è¯ï¼Œå¼‚æ­¥ä»»åŠ¡æ”¯æŒ
- **CLI å‘½ä»¤**ï¼šæŒ‰ç”¨æˆ·æ“ä½œæ­¥éª¤è®¾è®¡ï¼Œå‹å¥½çš„è¾“å‡ºï¼Œè¿›åº¦å±•ç¤º

### æ€§èƒ½éªŒæ”¶

- **æ‰¹é‡å¤„ç†**ï¼šæ”¯æŒè‡³å°‘ 100 ä¸ªé¡¹ç›®
- **å¹¶å‘æ§åˆ¶**ï¼šæ”¯æŒ 5-10 ä¸ªå¹¶å‘é…ç½®
- **å“åº”æ—¶é—´**ï¼šé…ç½®å•ä¸ª Mirror < 5 ç§’
- **å¤§ä»“åº“æ”¯æŒ**ï¼šæ”¯æŒ 1GB+ ä»“åº“ï¼ˆé¦–æ¬¡åŒæ­¥å¯èƒ½éœ€ 30 åˆ†é’Ÿ+ï¼‰
- **API é™æµ**ï¼šè‡ªåŠ¨å¤„ç† 429 é”™è¯¯

### è´¨é‡éªŒæ”¶

- **é…ç½®éªŒè¯**ï¼šé…ç½®æ–‡ä»¶æ ¼å¼å’Œå†…å®¹éªŒè¯
- **é”™è¯¯æç¤º**ï¼šæ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’Œä¿®å¤å»ºè®®
- **æ—¥å¿—å¯è¿½æº¯**ï¼šæ‰€æœ‰æ“ä½œæœ‰æ—¥å¿—è®°å½•
- **çŠ¶æ€æŒä¹…åŒ–**ï¼šé‡å¯åçŠ¶æ€å¯æ¢å¤
- **API æ–‡æ¡£**ï¼šå®Œæ•´çš„ API æ–‡æ¡£
- **ç”¨æˆ·ä½“éªŒ**ï¼šå‹å¥½çš„ CLI è¾“å‡ºï¼Œå½©è‰²è¿›åº¦æ¡

---

## ğŸ’¡ æŠ€æœ¯æ ˆ

### åŒæ­¥æœåŠ¡ç«¯
- **è¯­è¨€**ï¼šPython 3.8+
- **Web æ¡†æ¶**ï¼šFlask / FastAPIï¼ˆæ¨è FastAPIï¼‰
- **GitLab å®¢æˆ·ç«¯**ï¼špython-gitlab
- **æ•°æ®åº“ ORM**ï¼šSQLAlchemy
- **é…ç½®è§£æ**ï¼šPyYAML
- **æ—¥å¿—åº“**ï¼šLoguru / structlog
- **å¼‚æ­¥ä»»åŠ¡**ï¼šCeleryï¼ˆå¯é€‰ï¼Œç”¨äºåå°ä»»åŠ¡ï¼‰

### CLI å®¢æˆ·ç«¯
- **è¯­è¨€**ï¼šPython 3.8+
- **CLI æ¡†æ¶**ï¼šClick / Typerï¼ˆæ¨è Typerï¼‰
- **HTTP å®¢æˆ·ç«¯**ï¼šhttpx / requests
- **è¿›åº¦å±•ç¤º**ï¼šrichï¼ˆå½©è‰²è¾“å‡ºå’Œè¿›åº¦æ¡ï¼‰
- **é…ç½®è§£æ**ï¼šPyYAML
- **è¡¨æ ¼è¾“å‡º**ï¼štabulate

### å¼€å‘å·¥å…·
- **ä»£ç è´¨é‡**ï¼šblack, flake8, mypy
- **æµ‹è¯•æ¡†æ¶**ï¼špytest
- **API æ–‡æ¡£**ï¼šOpenAPI / Swaggerï¼ˆFastAPI è‡ªåŠ¨ç”Ÿæˆï¼‰
- **å®¹å™¨åŒ–**ï¼šDockerï¼ˆå¯é€‰ï¼‰

---

## ğŸ“š å‚è€ƒèµ„æº

- [GitLab Remote Mirrors API](https://docs.gitlab.com/ee/api/remote_mirrors.html)
- [GitLab Push Mirroring æ–‡æ¡£](https://docs.gitlab.com/user/project/repository/mirror/push/)
- [FastAPI æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [Click/Typer æ–‡æ¡£](https://typer.tiangolo.com/)

---

**æœ€åæ›´æ–°**: 2025-12-13
**æ–‡æ¡£ç‰ˆæœ¬**: v2.0
**æ¶æ„**: å®¢æˆ·ç«¯/æœåŠ¡ç«¯åˆ†ç¦» + REST API
