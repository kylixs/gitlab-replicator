groups:
  - name: gitlab_mirror_system_alerts
    interval: 30s
    rules:
      # 同步异常数量过多告警
      - alert: GitLabMirrorSyncAnomaliesHigh
        expr: |
          (gitlab_mirror_sync_status{status="outdated"} + gitlab_mirror_sync_status{status="failed"})
          / gitlab_mirror_projects_total > 0.1
        for: 5m
        labels:
          severity: warning
          component: sync
        annotations:
          summary: "GitLab Mirror同步异常比例过高"
          description: "当前同步异常项目比例为 {{ $value | humanizePercentage }}，超过10%阈值"

      # 同步失败过多告警
      - alert: GitLabMirrorSyncFailedHigh
        expr: gitlab_mirror_sync_status{status="failed"} > 10
        for: 5m
        labels:
          severity: critical
          component: sync
        annotations:
          summary: "GitLab Mirror同步失败项目过多"
          description: "当前有 {{ $value }} 个项目同步失败"

      # 存在Critical告警
      - alert: GitLabMirrorCriticalAlerts
        expr: gitlab_mirror_alerts_active{severity="critical"} > 0
        for: 1m
        labels:
          severity: critical
          component: alert
        annotations:
          summary: "GitLab Mirror存在Critical级别告警"
          description: "当前有 {{ $value }} 个Critical告警需要立即处理"

      # 扫描耗时过长
      - alert: GitLabMirrorScanSlow
        expr: gitlab_mirror_scan_duration_seconds > 15
        for: 5m
        labels:
          severity: warning
          component: performance
        annotations:
          summary: "GitLab Mirror扫描耗时过长"
          description: "扫描耗时 {{ $value }}秒，超过15秒阈值"

      # API调用频率过高
      - alert: GitLabMirrorAPIRateHigh
        expr: rate(gitlab_mirror_api_calls_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: "GitLab API调用频率过高"
          description: "API调用频率 {{ $value | humanize }}/秒，可能触发速率限制"

  - name: gitlab_mirror_project_alerts
    interval: 1m
    rules:
      # 项目Commit差异过大
      - alert: GitLabMirrorProjectCommitDiffHigh
        expr: |
          abs(gitlab_mirror_project_commits{type="source"} -
          gitlab_mirror_project_commits{type="target"}) > 10
        for: 10m
        labels:
          severity: high
          component: sync
        annotations:
          summary: "项目 {{ $labels.project }} Commit差异过大"
          description: "项目 {{ $labels.project }} 的Commit差异为 {{ $value }}，超过10个commit阈值"

      # 项目同步延迟过长
      - alert: GitLabMirrorProjectSyncDelayHigh
        expr: |
          (time() - gitlab_mirror_project_last_commit_time{type="target"}) -
          (time() - gitlab_mirror_project_last_commit_time{type="source"}) > 3600
        for: 10m
        labels:
          severity: medium
          component: sync
        annotations:
          summary: "项目 {{ $labels.project }} 同步延迟过长"
          description: "项目 {{ $labels.project }} 同步延迟 {{ $value | humanizeDuration }}，超过1小时"

      # 项目大小差异过大
      - alert: GitLabMirrorProjectSizeDiffHigh
        expr: |
          abs(gitlab_mirror_project_size_bytes{type="source"} -
          gitlab_mirror_project_size_bytes{type="target"}) /
          gitlab_mirror_project_size_bytes{type="source"} > 0.1
        for: 15m
        labels:
          severity: low
          component: sync
        annotations:
          summary: "项目 {{ $labels.project }} 大小差异过大"
          description: "项目 {{ $labels.project }} 大小差异为 {{ $value | humanizePercentage }}，超过10%阈值"

  - name: gitlab_mirror_availability_alerts
    interval: 30s
    rules:
      # 监控服务不可用
      - alert: GitLabMirrorServiceDown
        expr: up{job="gitlab-mirror"} == 0
        for: 1m
        labels:
          severity: critical
          component: service
        annotations:
          summary: "GitLab Mirror服务不可用"
          description: "GitLab Mirror服务已停止响应超过1分钟"

      # 缓存大小接近上限
      - alert: GitLabMirrorCacheNearFull
        expr: gitlab_mirror_cache_size > 900
        for: 5m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "GitLab Mirror缓存接近上限"
          description: "当前缓存大小 {{ $value }}，接近1000上限"

      # 活跃告警数量过多
      - alert: GitLabMirrorTooManyActiveAlerts
        expr: sum(gitlab_mirror_alerts_active) > 50
        for: 10m
        labels:
          severity: warning
          component: alert
        annotations:
          summary: "GitLab Mirror活跃告警过多"
          description: "当前有 {{ $value }} 个活跃告警，需要批量处理"

  - name: gitlab_mirror_trend_alerts
    interval: 5m
    rules:
      # 项目数量突增
      - alert: GitLabMirrorProjectCountSpike
        expr: |
          (gitlab_mirror_projects_total - gitlab_mirror_projects_total offset 1h) > 100
        for: 5m
        labels:
          severity: info
          component: discovery
        annotations:
          summary: "GitLab Mirror项目数量突增"
          description: "1小时内新增 {{ $value }} 个项目"

      # 告警触发频率异常
      - alert: GitLabMirrorAlertRateHigh
        expr: rate(gitlab_mirror_alerts_active[15m]) > 0.5
        for: 10m
        labels:
          severity: warning
          component: alert
        annotations:
          summary: "GitLab Mirror告警触发频率异常"
          description: "告警触发频率 {{ $value | humanize }}/秒，可能存在系统问题"
