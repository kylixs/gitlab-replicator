# ç»Ÿä¸€é¡¹ç›®ç›‘æ§æ–¹æ¡ˆè®¾è®¡

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv3.0
**æ›´æ–°æ—¥æœŸ**ï¼š2025-12-14
**ä½œè€…**ï¼šGitLab Mirror Team

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

### èƒŒæ™¯å’Œç›®çš„

å½“å‰ç³»ç»Ÿåœ¨é¡¹ç›®å‘ç°å’ŒåŒæ­¥ç›‘æ§æ–¹é¢å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

**é¡¹ç›®å‘ç°å±‚é¢**ï¼š
- å®šæ—¶å…¨é‡æ‰«ææ•ˆç‡ä½ï¼Œæ–°é¡¹ç›®å‘ç°å»¶è¿Ÿé•¿ï¼ˆ30åˆ†é’Ÿï¼‰
- æ¯æ¬¡éƒ½æŸ¥è¯¢æ‰€æœ‰é¡¹ç›®ï¼Œæœªåˆ©ç”¨å¢é‡æŸ¥è¯¢èƒ½åŠ›
- APIè°ƒç”¨é¢‘ç¹ï¼Œæœªåšæ‰¹é‡ä¼˜åŒ–

**åŒæ­¥ç›‘æ§å±‚é¢**ï¼š
- ç¼ºå°‘æºå’Œç›®æ ‡é¡¹ç›®çŠ¶æ€çš„å¯¹æ¯”æœºåˆ¶
- æ— æ³•å¿«é€Ÿå‘ç°åŒæ­¥å¼‚å¸¸ï¼ˆå»¶è¿Ÿã€å¤±è´¥ã€ä¸ä¸€è‡´ï¼‰
- ç¼ºå°‘æ•´ä½“åŒæ­¥å¥åº·åº¦çš„é‡åŒ–æŒ‡æ ‡
- ç¼ºå°‘PrometheusæŒ‡æ ‡å¯¼å‡ºï¼Œæ— æ³•æ¥å…¥ç›‘æ§ç³»ç»Ÿ

æœ¬æ–¹æ¡ˆè®¾è®¡ä¸€ä¸ª**ç»Ÿä¸€çš„é¡¹ç›®ç›‘æ§æœåŠ¡**ï¼Œé€šè¿‡ä¸€å¥—æ‰¹é‡æŸ¥è¯¢æœºåˆ¶åŒæ—¶è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š

1. **ä¼˜åŒ–é¡¹ç›®å‘ç°**ï¼šå¢é‡æŸ¥è¯¢ + å…¨é‡å¯¹è´¦ï¼Œæå‡å‘ç°æ•ˆç‡
2. **ç›‘æ§åŒæ­¥çŠ¶æ€**ï¼šå¯¹æ¯”æºå’Œç›®æ ‡å·®å¼‚ï¼Œæ£€æµ‹å¼‚å¸¸
3. **å…±äº«æŸ¥è¯¢ç»“æœ**ï¼šä¸€æ¬¡æŸ¥è¯¢ï¼ŒåŒæ—¶ç”¨äºå‘ç°å’Œç›‘æ§
4. **Prometheusé›†æˆ**ï¼šå¯¼å‡ºç›‘æ§æŒ‡æ ‡ï¼Œæ¥å…¥ç°æœ‰ç›‘æ§ä½“ç³»

### æ ¸å¿ƒä¼˜åŒ–

ç›¸æ¯”v2.0æ–¹æ¡ˆï¼Œæœ¬ç‰ˆæœ¬åšäº†ä»¥ä¸‹ä¼˜åŒ–ï¼š

- **å¤ç”¨ç°æœ‰è¡¨**ï¼šæ‰©å±•SOURCE_PROJECT_INFOå’ŒTARGET_PROJECT_INFOï¼Œä¸åˆ›å»ºæ–°çš„å¿«ç…§è¡¨
- **å†…å­˜è®¡ç®—å·®å¼‚**ï¼šå·®å¼‚å¯¹æ¯”ç»“æœä»…ç¼“å­˜åœ¨å†…å­˜ï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰ï¼Œä¸æŒä¹…åŒ–åˆ°æ•°æ®åº“
- **è½»é‡åŒ–å‘Šè­¦**ï¼šä»…åœ¨æ£€æµ‹åˆ°å¼‚å¸¸æ—¶è®°å½•å‘Šè­¦äº‹ä»¶
- **Prometheuså¯¼å‡º**ï¼šæä¾›æ ‡å‡†Metricsæ¥å£ï¼Œæ˜“äºé›†æˆGrafana
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šæŸ¥è¯¢/æ‰«æå½’å±åŒæ­¥æ¨¡å—ï¼Œç›‘æ§å¯¼å‡ºå½’å±ç›‘æ§æ¨¡å—
- **é¡¹ç›®çº§æŒ‡æ ‡**ï¼šæ–°å¢é¡¹ç›®çº§PrometheusæŒ‡æ ‡ï¼Œæ”¯æŒç»†ç²’åº¦ç›‘æ§
- **ç®€åŒ–ä¾èµ–**ï¼šä½¿ç”¨æœ¬åœ°å†…å­˜ç¼“å­˜æ›¿ä»£Redisï¼Œé™ä½ç³»ç»Ÿå¤æ‚åº¦

### æ ¸å¿ƒæ€è·¯

```
æ‰¹é‡æŸ¥è¯¢ GitLab API
      â†“
æ›´æ–°ç°æœ‰é¡¹ç›®è¡¨ï¼ˆSOURCE_PROJECT_INFO/TARGET_PROJECT_INFOï¼‰
      â†“
å†…å­˜è®¡ç®—å·®å¼‚ï¼ˆç¼“å­˜åˆ°æœ¬åœ°å†…å­˜ï¼ŒTTL 15åˆ†é’Ÿï¼‰
      â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                           â†“
é¡¹ç›®å‘ç°é€»è¾‘              åŒæ­¥ç›‘æ§é€»è¾‘
- æ–°é¡¹ç›®æ£€æµ‹              - æº/ç›®æ ‡å¯¹æ¯”
- æ›´æ–°æ£€æµ‹                - å¼‚å¸¸æ£€æµ‹
- åˆ é™¤æ£€æµ‹                - å‘Šè­¦äº‹ä»¶
- è§¦å‘åŒæ­¥                - PrometheusæŒ‡æ ‡
```

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„

```mermaid
graph TB
    subgraph "è§¦å‘æº"
        S1[å®šæ—¶è°ƒåº¦å™¨<br/>å¢é‡5min/å…¨é‡1å¤©]
        S2[æ‰‹åŠ¨è§¦å‘<br/>CLI/API]
    end

    subgraph "ç»Ÿä¸€ç›‘æ§æœåŠ¡"
        UMS[UnifiedProjectMonitor]

        subgraph "æ‰¹é‡æŸ¥è¯¢å±‚"
            BQ[BatchQueryExecutor]
            REST[REST APIå®¢æˆ·ç«¯]
        end

        subgraph "æ•°æ®å¤„ç†å±‚"
            UPD[æ›´æ–°é¡¹ç›®è¡¨<br/>UpdateProjectData]
            DC[å†…å­˜å·®å¼‚è®¡ç®—<br/>DiffCalculator]
        end

        subgraph "ä¸šåŠ¡é€»è¾‘å±‚"
            PD[é¡¹ç›®å‘ç°<br/>ProjectDiscovery]
            SM[åŒæ­¥ç›‘æ§<br/>SyncMonitor]
        end

        subgraph "ç›‘æ§è¾“å‡º"
            AE[å‘Šè­¦äº‹ä»¶<br/>AlertEvent]
            PE[Prometheuså¯¼å‡º<br/>MetricsExporter]
        end
    end

    subgraph "å­˜å‚¨å±‚"
        DB[(MySQL)]
        CACHE[(æœ¬åœ°å†…å­˜ç¼“å­˜<br/>å·®å¼‚ç¼“å­˜)]
    end

    S1 --> UMS
    S2 --> UMS

    UMS --> BQ
    BQ --> REST

    BQ --> UPD
    UPD --> DC

    DC --> PD
    DC --> SM

    PD --> DB
    SM --> AE
    SM --> PE

    AE --> DB
    PE --> PROM[Prometheus]

    DC --> CACHE
    UPD --> DB

    style UMS fill:#FFD700
    style BQ fill:#90EE90
    style DC fill:#87CEEB
    style PE fill:#FFE4B5
```

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | èŒè´£ | è¾“å…¥ | è¾“å‡º |
|------|------|------|------|
| UnifiedProjectMonitor | ç»Ÿä¸€å…¥å£ï¼Œåè°ƒå„æ¨¡å— | è§¦å‘ä¿¡å· | æ‰§è¡Œç»“æœ |
| BatchQueryExecutor | æ‰¹é‡æŸ¥è¯¢é¡¹ç›®ä¿¡æ¯ | é¡¹ç›®åˆ—è¡¨/æŸ¥è¯¢æ¡ä»¶ | é¡¹ç›®çŠ¶æ€åˆ—è¡¨ |
| UpdateProjectData | æ›´æ–°ç°æœ‰é¡¹ç›®è¡¨ | GitLabæŸ¥è¯¢ç»“æœ | æ›´æ–°æ•°æ®åº“ |
| DiffCalculator | å†…å­˜è®¡ç®—å·®å¼‚ | æº/ç›®æ ‡é¡¹ç›®æ•°æ® | å·®å¼‚å¯¹è±¡ï¼ˆç¼“å­˜åˆ°Redisï¼‰ |
| ProjectDiscovery | é¡¹ç›®å‘ç°é€»è¾‘ | å·®å¼‚æ•°æ® | æ–°å¢/æ›´æ–°/åˆ é™¤é¡¹ç›® |
| SyncMonitor | åŒæ­¥ç›‘æ§é€»è¾‘ | å·®å¼‚æ•°æ® | å‘Šè­¦äº‹ä»¶/PrometheusæŒ‡æ ‡ |
| MetricsExporter | PrometheusæŒ‡æ ‡å¯¼å‡º | ç›‘æ§æ•°æ® | Metricsæ¥å£ |

### æŠ€æœ¯æ ˆ

- **Spring Boot 3.x**ï¼šæ ¸å¿ƒæ¡†æ¶
- **GitLab REST API v4**ï¼šé¡¹ç›®æŸ¥è¯¢ï¼ˆæ”¯æŒupdated_afterå¢é‡æŸ¥è¯¢ï¼‰
- **CompletableFuture**ï¼šå¹¶å‘æŸ¥è¯¢ä¼˜åŒ–
- **Redis**ï¼šå·®å¼‚ç»“æœå†…å­˜ç¼“å­˜ï¼ˆTTL 15åˆ†é’Ÿï¼‰
- **Micrometer**ï¼šPrometheusæŒ‡æ ‡å¯¼å‡º
- **MyBatis-Plus**ï¼šæ•°æ®åº“æ“ä½œ

## ğŸ“Š æ ¸å¿ƒå®ä½“åŠå…³ç³»

### ER å›¾

```mermaid
erDiagram
    SYNC_PROJECT ||--|| SOURCE_PROJECT_INFO : "å…³è”æºé¡¹ç›®"
    SYNC_PROJECT ||--|| TARGET_PROJECT_INFO : "å…³è”ç›®æ ‡é¡¹ç›®"
    SYNC_PROJECT ||--o{ MONITOR_ALERT : "äº§ç”Ÿå‘Šè­¦"

    SOURCE_PROJECT_INFO {
        bigint id PK
        bigint sync_project_id FK "å…³è”é¡¹ç›®"
        int gitlab_project_id "GitLabé¡¹ç›®ID"
        string path_with_namespace "é¡¹ç›®è·¯å¾„"
        string default_branch "é»˜è®¤åˆ†æ”¯"
        string latest_commit_sha "æœ€æ–°æäº¤SHA"
        int commit_count "æäº¤æ•°é‡"
        int branch_count "åˆ†æ”¯æ•°é‡"
        bigint repository_size "ä»“åº“å¤§å°"
        datetime last_activity_at "æœ€åæ´»åŠ¨æ—¶é—´"
        datetime synced_at "åŒæ­¥æ—¶é—´"
        datetime updated_at "æ›´æ–°æ—¶é—´"
    }

    TARGET_PROJECT_INFO {
        bigint id PK
        bigint sync_project_id FK "å…³è”é¡¹ç›®"
        int gitlab_project_id "GitLabé¡¹ç›®ID"
        string path_with_namespace "é¡¹ç›®è·¯å¾„"
        string default_branch "é»˜è®¤åˆ†æ”¯"
        string latest_commit_sha "æœ€æ–°æäº¤SHA"
        int commit_count "æäº¤æ•°é‡"
        int branch_count "åˆ†æ”¯æ•°é‡"
        bigint repository_size "ä»“åº“å¤§å°"
        datetime last_activity_at "æœ€åæ´»åŠ¨æ—¶é—´"
        datetime synced_at "åŒæ­¥æ—¶é—´"
        datetime updated_at "æ›´æ–°æ—¶é—´"
    }

    MONITOR_ALERT {
        bigint id PK
        bigint sync_project_id FK "å…³è”é¡¹ç›®"
        string alert_type "å‘Šè­¦ç±»å‹"
        string severity "ä¸¥é‡ç¨‹åº¦"
        string title "å‘Šè­¦æ ‡é¢˜"
        text description "å‘Šè­¦æè¿°"
        text metadata "å…ƒæ•°æ®JSON"
        string status "çŠ¶æ€"
        datetime triggered_at "è§¦å‘æ—¶é—´"
        datetime resolved_at "è§£å†³æ—¶é—´"
    }
```

### å®ä½“æ‰©å±•è¯´æ˜

#### SOURCE_PROJECT_INFOï¼ˆæ‰©å±•å­—æ®µï¼‰

åœ¨ç°æœ‰è¡¨åŸºç¡€ä¸Šå¢åŠ ä»¥ä¸‹å­—æ®µï¼š

| æ–°å¢å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|---------|------|------|------|
| latest_commit_sha | VARCHAR(64) | | æœ€æ–°æäº¤SHAï¼ˆé»˜è®¤åˆ†æ”¯ï¼‰ |
| commit_count | INT | | æäº¤æ•°é‡ï¼ˆå¯é€‰ï¼Œæ€§èƒ½è€ƒè™‘ï¼‰ |
| branch_count | INT | | åˆ†æ”¯æ•°é‡ |
| repository_size | BIGINT | | ä»“åº“å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| last_activity_at | DATETIME | | æœ€åæ´»åŠ¨æ—¶é—´ |

**ç´¢å¼•ä¼˜åŒ–**ï¼š
- INDEX: `last_activity_at`ï¼ˆç”¨äºå¢é‡æŸ¥è¯¢ï¼‰

#### TARGET_PROJECT_INFOï¼ˆæ‰©å±•å­—æ®µï¼‰

åœ¨ç°æœ‰è¡¨åŸºç¡€ä¸Šå¢åŠ ç›¸åŒå­—æ®µï¼š

| æ–°å¢å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|---------|------|------|------|
| latest_commit_sha | VARCHAR(64) | | æœ€æ–°æäº¤SHAï¼ˆé»˜è®¤åˆ†æ”¯ï¼‰ |
| commit_count | INT | | æäº¤æ•°é‡ï¼ˆå¯é€‰ï¼‰ |
| branch_count | INT | | åˆ†æ”¯æ•°é‡ |
| repository_size | BIGINT | | ä»“åº“å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| last_activity_at | DATETIME | | æœ€åæ´»åŠ¨æ—¶é—´ |

#### MONITOR_ALERTï¼ˆæ–°å¢è¡¨ï¼‰

è®°å½•ç›‘æ§æ£€æµ‹åˆ°çš„å‘Šè­¦äº‹ä»¶ã€‚

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | BIGINT | PK, AUTO_INCREMENT | ä¸»é”® |
| sync_project_id | BIGINT | FK, NOT NULL | å…³è”SYNC_PROJECT |
| alert_type | VARCHAR(50) | NOT NULL | å‘Šè­¦ç±»å‹ï¼šsync_delay/commit_diff/branch_diff/size_diff/target_missing |
| severity | VARCHAR(20) | NOT NULL | ä¸¥é‡ç¨‹åº¦ï¼šcritical/high/medium/low |
| title | VARCHAR(255) | NOT NULL | å‘Šè­¦æ ‡é¢˜ |
| description | TEXT | NOT NULL | å‘Šè­¦æè¿° |
| metadata | TEXT | | å…ƒæ•°æ®ï¼ˆJSONæ ¼å¼ï¼ŒåŒ…å«å·®å¼‚è¯¦æƒ…ï¼‰ |
| status | VARCHAR(20) | NOT NULL | çŠ¶æ€ï¼šactive/acknowledged/resolved/muted |
| triggered_at | DATETIME | NOT NULL | è§¦å‘æ—¶é—´ |
| resolved_at | DATETIME | | è§£å†³æ—¶é—´ |
| created_at | DATETIME | NOT NULL | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- FK: `sync_project_id`
- INDEX: `(status, severity, triggered_at)`
- INDEX: `(alert_type, triggered_at)`

**å‘Šè­¦ç±»å‹è¯´æ˜**ï¼š
- `sync_delay`ï¼šåŒæ­¥å»¶è¿Ÿè¶…è¿‡é˜ˆå€¼
- `commit_diff`ï¼šCommit SHAä¸ä¸€è‡´
- `branch_diff`ï¼šåˆ†æ”¯æ•°é‡ä¸ä¸€è‡´
- `size_diff`ï¼šä»“åº“å¤§å°å·®å¼‚è¿‡å¤§
- `target_missing`ï¼šç›®æ ‡é¡¹ç›®ä¸å­˜åœ¨

### æœ¬åœ°å†…å­˜ç¼“å­˜ç»“æ„

ä½¿ç”¨ `ConcurrentHashMap` + è¿‡æœŸæ—¶é—´ç®¡ç†å®ç°æœ¬åœ°å†…å­˜ç¼“å­˜ã€‚

**å·®å¼‚æ•°æ®ç¼“å­˜**ï¼ˆTTL: 15åˆ†é’Ÿï¼‰ï¼š

```java
// Cache Key: project_key
// Cache Value: ProjectDiffResult
{
  "source": {
    "commit_sha": "abc123...",
    "commit_count": 245,
    "branch_count": 3,
    "size_bytes": 15925248,
    "last_activity_at": "2025-12-14T10:15:00Z"
  },
  "target": {
    "commit_sha": "def456...",
    "commit_count": 240,
    "branch_count": 3,
    "size_bytes": 15823456,
    "last_activity_at": "2025-12-14T09:30:00Z"
  },
  "diff": {
    "commit_behind": 5,
    "sync_delay_minutes": 45,
    "size_diff_percent": 0.66,
    "branch_diff": 0
  },
  "status": "outdated",
  "checked_at": "2025-12-14T10:30:00Z",
  "expires_at": "2025-12-14T10:45:00Z"  // TTL 15åˆ†é’Ÿ
}
```

**ç›‘æ§ç»Ÿè®¡ç¼“å­˜**ï¼ˆTTL: 5åˆ†é’Ÿï¼‰ï¼š

```java
// Cache Key: "monitor:stats
Value: {
  "total_projects": 127,
  "synced": 118,
  "outdated": 5,
  "failed": 2,
  "inconsistent": 2,
  "health_score": 92.5,
  "updated_at": "2025-12-14T10:30:00Z"
}
```

## ğŸ”„ å…³é”®å¤„ç†æµç¨‹

### 1. å¢é‡ç›‘æ§æµç¨‹ï¼ˆæ¯5åˆ†é’Ÿï¼‰

```mermaid
graph TD
    A[å®šæ—¶è§¦å‘<br/>æ¯5åˆ†é’Ÿ] --> B[è·å–last_scan_time]
    B --> C[æ‰¹é‡æŸ¥è¯¢æºGitLab<br/>updated_afterå‚æ•°]

    C --> D{æœ‰æ›´æ–°é¡¹ç›®?}
    D -->|å¦| E[æ›´æ–°scan_time]
    D -->|æ˜¯| F[æ›´æ–°SOURCE_PROJECT_INFO<br/>æ‰©å±•å­—æ®µ]

    F --> G[æŸ¥è¯¢å¯¹åº”çš„<br/>TARGET_PROJECT_INFO]

    G --> H[å†…å­˜è®¡ç®—å·®å¼‚<br/>DiffCalculator]
    H --> I[ç¼“å­˜åˆ°Redis<br/>15åˆ†é’ŸTTL]

    I --> J{æ£€æµ‹å˜åŒ–ç±»å‹}
    J -->|æ–°é¡¹ç›®| K[åˆ›å»ºSYNC_PROJECT<br/>åˆ›å»ºPullé…ç½®]
    J -->|commitæ›´æ–°| L[è§¦å‘åŒæ­¥ä»»åŠ¡]
    J -->|ä»…é…ç½®æ›´æ–°| M[è·³è¿‡åŒæ­¥]

    I --> N{æ£€æµ‹å¼‚å¸¸}
    N -->|å»¶è¿Ÿè¶…é™| O[åˆ›å»ºMONITOR_ALERT<br/>sync_delay]
    N -->|commitå·®å¼‚å¤§| P[åˆ›å»ºMONITOR_ALERT<br/>commit_diff]
    N -->|æ— å¼‚å¸¸| Q[æ¸…é™¤æ—§å‘Šè­¦]

    K --> R[æ›´æ–°PrometheusæŒ‡æ ‡]
    L --> R
    O --> R
    P --> R
    Q --> R
    M --> R
    E --> R

    R --> S[å®Œæˆ]

    style D fill:#FFD700
    style J fill:#FFD700
    style N fill:#FFD700
    style O fill:#FFB6C1
    style P fill:#FFB6C1
    style K fill:#90EE90
```

### 2. å…¨é‡å¯¹è´¦æµç¨‹ï¼ˆæ¯å¤©1æ¬¡ï¼‰

```mermaid
graph TD
    A[å®šæ—¶è§¦å‘<br/>æ¯å¤©2:00] --> B[æ‰¹é‡æŸ¥è¯¢æ‰€æœ‰æºé¡¹ç›®]
    B --> C[æ‰¹é‡æŸ¥è¯¢æ‰€æœ‰ç›®æ ‡é¡¹ç›®]

    C --> D[æ‰¹é‡æ›´æ–°é¡¹ç›®è¡¨<br/>SOURCE & TARGET]
    D --> E[æ‰¹é‡è®¡ç®—å·®å¼‚<br/>å†…å­˜å¤„ç†]

    E --> F[ç¼“å­˜å·®å¼‚åˆ°Redis]
    F --> G{å¯¹è´¦æ£€æŸ¥}

    G --> H[æ£€æŸ¥æ–°é¡¹ç›®]
    G --> I[æ£€æŸ¥åˆ é™¤é¡¹ç›®]
    G --> J[æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§]

    H --> K{å‘ç°æ–°é¡¹ç›®?}
    K -->|æ˜¯| L[æ‰¹é‡åˆ›å»º<br/>SYNC_PROJECT]
    K -->|å¦| M[è·³è¿‡]

    I --> N{å‘ç°åˆ é™¤?}
    N -->|æ˜¯| O[æ ‡è®°deleted<br/>åˆ›å»ºå‘Šè­¦]
    N -->|å¦| M

    J --> P{å‘ç°å¼‚å¸¸?}
    P -->|æ˜¯| Q[æ‰¹é‡åˆ›å»º<br/>MONITOR_ALERT]
    P -->|å¦| M

    L --> R[ç”Ÿæˆå¯¹è´¦æŠ¥å‘Š]
    O --> R
    Q --> R
    M --> R

    R --> S[æ›´æ–°PrometheusæŒ‡æ ‡]
    S --> T[å®Œæˆ]

    style G fill:#FFD700
    style K fill:#FFD700
    style N fill:#FFD700
    style P fill:#FFD700
    style L fill:#90EE90
    style O fill:#FFB6C1
    style Q fill:#FFB6C1
```

### 3. å·®å¼‚è®¡ç®—æµç¨‹

```mermaid
graph LR
    A[è·å–æºé¡¹ç›®ä¿¡æ¯] --> B[è·å–ç›®æ ‡é¡¹ç›®ä¿¡æ¯]
    B --> C{ç›®æ ‡å­˜åœ¨?}

    C -->|å¦| D[åˆ›å»ºå‘Šè­¦<br/>target_missing]
    C -->|æ˜¯| E[é€å­—æ®µå¯¹æ¯”]

    E --> F[commit_sha]
    E --> G[branch_count]
    E --> H[repository_size]
    E --> I[last_activity_at]

    F --> J{è®¡ç®—å·®å¼‚}
    G --> J
    H --> J
    I --> J

    J --> K{åº”ç”¨é˜ˆå€¼è§„åˆ™}
    K --> L{éœ€è¦å‘Šè­¦?}

    L -->|æ˜¯| M[åˆ›å»ºMONITOR_ALERT]
    L -->|å¦| N[ä»…è®°å½•å·®å¼‚]

    D --> O[æ„å»ºå·®å¼‚å¯¹è±¡]
    M --> O
    N --> O

    O --> P[ç¼“å­˜åˆ°Redis<br/>15åˆ†é’Ÿ]

    style C fill:#FFD700
    style K fill:#FFD700
    style L fill:#FFD700
    style D fill:#FFB6C1
    style M fill:#FFE4B5
```

### 4. PrometheusæŒ‡æ ‡å¯¼å‡ºæµç¨‹

```mermaid
graph LR
    A[Prometheusæ‹‰å–<br/>/actuator/prometheus] --> B[MetricsExporter]

    B --> C[ä»Redisè¯»å–<br/>ç›‘æ§ç»Ÿè®¡]
    B --> D[æŸ¥è¯¢æ•°æ®åº“<br/>å‘Šè­¦ç»Ÿè®¡]

    C --> E[è®¡ç®—æŒ‡æ ‡]
    D --> E

    E --> F[é¡¹ç›®æ€»æ•°<br/>gitlab_mirror_projects_total]
    E --> G[åŒæ­¥çŠ¶æ€åˆ†å¸ƒ<br/>gitlab_mirror_sync_status]
    E --> H[å¥åº·è¯„åˆ†<br/>gitlab_mirror_health_score]
    E --> I[æ´»è·ƒå‘Šè­¦æ•°<br/>gitlab_mirror_alerts_active]
    E --> J[APIè°ƒç”¨æ¬¡æ•°<br/>gitlab_mirror_api_calls_total]

    F --> K[è¿”å›Metricsæ ¼å¼]
    G --> K
    H --> K
    I --> K
    J --> K

    style B fill:#FFD700
    style E fill:#87CEEB
    style K fill:#90EE90
```

## ğŸ”Œ REST API è®¾è®¡

### API ç«¯ç‚¹åˆ—è¡¨

æŒ‰æ¨¡å—åˆ’åˆ†ï¼š

#### åŒæ­¥æ¨¡å— APIs

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | æƒé™ |
|------|------|------|------|
| POST | /api/sync/scan | æ‰‹åŠ¨è§¦å‘æ‰«æï¼ˆå‘ç°+æ›´æ–°ï¼‰ | ADMIN |
| GET | /api/sync/projects | è·å–é¡¹ç›®åˆ—è¡¨ï¼ˆå¸¦åŒæ­¥çŠ¶æ€ï¼‰ | READ |
| GET | /api/sync/projects/{projectKey} | è·å–é¡¹ç›®è¯¦æƒ… | READ |
| GET | /api/sync/projects/{projectKey}/diff | è·å–é¡¹ç›®å·®å¼‚è¯¦æƒ… | READ |

#### ç›‘æ§æ¨¡å— APIs

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | æƒé™ |
|------|------|------|------|
| GET | /api/monitor/status | è·å–ç›‘æ§æ€»è§ˆ | READ |
| GET | /api/monitor/alerts | è·å–å‘Šè­¦åˆ—è¡¨ | READ |
| POST | /api/monitor/alerts/{id}/resolve | æ ‡è®°å‘Šè­¦å·²è§£å†³ | ADMIN |
| POST | /api/monitor/alerts/{id}/mute | é™é»˜å‘Šè­¦ | ADMIN |
| GET | /actuator/prometheus | PrometheusæŒ‡æ ‡å¯¼å‡º | PUBLIC |

### è·å–ç›‘æ§æ€»è§ˆ

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```
GET /api/monitor/status
```

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "success": true,
  "data": {
    "summary": {
      "total_projects": 127,
      "synced": 118,
      "outdated": 5,
      "failed": 2,
      "inconsistent": 2
    },
    "health": {
      "score": 92.5,
      "grade": "Excellent"
    },
    "alerts": {
      "active": 9,
      "critical": 1,
      "high": 2,
      "medium": 3,
      "low": 3
    },
    "last_scan": {
      "time": "2025-12-14T10:30:00Z",
      "type": "incremental",
      "duration_ms": 8500
    }
  }
}
```

### è·å–é¡¹ç›®åˆ—è¡¨ï¼ˆåŒæ­¥æ¨¡å—ï¼‰

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```
GET /api/sync/projects?status=outdated&page=1&size=20
```

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "success": true,
  "data": {
    "projects": [
      {
        "project_key": "ai/test-node-app2",
        "status": "outdated",
        "diff": {
          "commit_behind": 5,
          "sync_delay_minutes": 45,
          "size_diff_percent": 0.66,
          "branch_diff": 0
        },
        "source": {
          "commit_sha": "abc123...",
          "last_activity": "2025-12-14T10:15:00Z"
        },
        "target": {
          "commit_sha": "def456...",
          "last_activity": "2025-12-14T09:30:00Z"
        }
      }
    ],
    "pagination": {
      "page": 1,
      "size": 20,
      "total": 5
    }
  }
}
```

### è·å–å‘Šè­¦åˆ—è¡¨

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```
GET /api/monitor/alerts?severity=critical&status=active
```

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "success": true,
  "data": {
    "alerts": [
      {
        "id": 123,
        "project_key": "arch/test-spring-app1",
        "alert_type": "commit_diff",
        "severity": "critical",
        "title": "Commitå·®å¼‚è¿‡å¤§",
        "description": "æºå’Œç›®æ ‡commit SHAä¸ä¸€è‡´ï¼Œå·®å¼‚15ä¸ªæäº¤",
        "metadata": {
          "source_sha": "abc123...",
          "target_sha": "def456...",
          "commit_diff": 15
        },
        "status": "active",
        "triggered_at": "2025-12-14T09:00:00Z"
      }
    ],
    "total": 1
  }
}
```

## ğŸ’» CLI å‘½ä»¤è®¾è®¡

### å‘½ä»¤åˆ—è¡¨

æŒ‰æ¨¡å—åˆ’åˆ†ï¼š

#### åŒæ­¥æ¨¡å— CLIs

| å‘½ä»¤ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| scan | è§¦å‘æ‰«æï¼ˆå‘ç°+æ›´æ–°ï¼‰ | `gitlab-mirror scan --type=incremental` |
| projects | åˆ—å‡ºé¡¹ç›®åŠåŒæ­¥çŠ¶æ€ | `gitlab-mirror projects --status=outdated` |
| diff | æŸ¥çœ‹é¡¹ç›®å·®å¼‚è¯¦æƒ… | `gitlab-mirror diff <project-key>` |

#### ç›‘æ§æ¨¡å— CLIs

| å‘½ä»¤ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| monitor status | æŸ¥çœ‹ç›‘æ§æ€»è§ˆ | `gitlab-mirror monitor status` |
| monitor alerts | æŸ¥çœ‹å‘Šè­¦åˆ—è¡¨ | `gitlab-mirror monitor alerts --severity=critical` |

### å‘½ä»¤è¾“å‡ºç¤ºä¾‹

#### monitor status

```bash
gitlab-mirror monitor status
```

**è¾“å‡º**ï¼š

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    Monitor Status Overview                     â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ğŸ“Š Projects Summary                                            â•‘
â•‘   Total:               127                                     â•‘
â•‘   âœ“ Synced:            118  (92.9%)                            â•‘
â•‘   âŸ³ Outdated:          5    (3.9%)                             â•‘
â•‘   âœ— Failed:            2    (1.6%)                             â•‘
â•‘   âš  Inconsistent:      2    (1.6%)                             â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ğŸ’š Health                                                      â•‘
â•‘   Score:               92.5 / 100                              â•‘
â•‘   Grade:               Excellent                               â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ğŸš¨ Active Alerts       9                                       â•‘
â•‘   ğŸ”´ Critical:         1                                       â•‘
â•‘   ğŸŸ  High:             2                                       â•‘
â•‘   ğŸŸ¡ Medium:           3                                       â•‘
â•‘   ğŸŸ¢ Low:              3                                       â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ğŸ”„ Last Scan                                                   â•‘
â•‘   Time:                2025-12-14 10:30:00 (2m ago)            â•‘
â•‘   Type:                Incremental                             â•‘
â•‘   Duration:            8.5s                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

#### diff

```bash
gitlab-mirror diff ai/test-node-app2
```

**è¾“å‡º**ï¼š

```
Project: ai/test-node-app2
Status:  ğŸŸ¡ outdated

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š Source vs Target
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Commit SHA:
  Source:  abc123... (2025-12-14 10:15:00)
  Target:  def456... (2025-12-14 09:30:00)
  âš  Diff:  5 commits behind

Branches:
  Source:  3
  Target:  3
  âœ“ Match

Size:
  Source:  15.2 MB
  Target:  15.1 MB
  â„¹ Diff:  +0.66%

Last Activity:
  Source:  2025-12-14 10:15:00
  Target:  2025-12-14 09:30:00
  âš  Delay: 45 minutes

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’¡ Recommendation
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Sync delay detected (45 minutes). Consider manual trigger.

Command: gitlab-mirror task trigger --pattern="ai/test-node-app2"
```

## âš™ï¸ å®æ–½è¦ç‚¹

### é…ç½®è¦æ±‚

```yaml
gitlab:
  mirror:
    monitor:
      # å¢é‡æ‰«æé—´éš”
      incremental-interval: 5m
      # å…¨é‡å¯¹è´¦Cron
      full-scan-cron: "0 0 2 * * ?"

      # æ‰¹é‡æŸ¥è¯¢é…ç½®
      batch:
        size: 20
        concurrency: 5
        timeout: 30s

      # å‘Šè­¦é˜ˆå€¼
      thresholds:
        # åŒæ­¥å»¶è¿Ÿé˜ˆå€¼ï¼ˆåˆ†é’Ÿï¼‰
        sync-delay-minutes: 30
        # ä¸¥é‡å»¶è¿Ÿé˜ˆå€¼ï¼ˆå°æ—¶ï¼‰
        critical-delay-hours: 2
        # Commitå·®å¼‚å‘Šè­¦é˜ˆå€¼
        commit-diff-alert: 10
        # å¤§å°å·®å¼‚å®¹å¿åº¦ï¼ˆç™¾åˆ†æ¯”ï¼‰
        size-diff-tolerance: 5

      # ç¼“å­˜é…ç½®
      cache:
        # å·®å¼‚ç¼“å­˜TTL
        diff-ttl: 15m
        # ç»Ÿè®¡ç¼“å­˜TTL
        stats-ttl: 5m

      # å‘Šè­¦é…ç½®
      alert:
        # è‡ªåŠ¨è§£å†³æ—¶é—´ï¼ˆå°æ—¶ï¼‰
        auto-resolve-hours: 24
        # é‡å¤å‘Šè­¦æŠ‘åˆ¶ï¼ˆåˆ†é’Ÿï¼‰
        duplicate-suppression-minutes: 60
```

### PrometheusæŒ‡æ ‡å®šä¹‰

#### ç³»ç»Ÿçº§ç»Ÿè®¡æŒ‡æ ‡

```
# é¡¹ç›®æ€»æ•°
gitlab_mirror_projects_total{} 127

# æŒ‰åŒæ­¥çŠ¶æ€åˆ†ç»„çš„é¡¹ç›®æ•°ï¼ˆé‡è¦ï¼šç”¨äºç›‘æ§åŒæ­¥å¼‚å¸¸æ•°é‡ï¼‰
gitlab_mirror_sync_status{status="synced"} 118
gitlab_mirror_sync_status{status="outdated"} 5
gitlab_mirror_sync_status{status="failed"} 2
gitlab_mirror_sync_status{status="inconsistent"} 2

# æ´»è·ƒå‘Šè­¦æ•°ï¼ˆæŒ‰ä¸¥é‡çº§åˆ«ï¼‰
gitlab_mirror_alerts_active{severity="critical"} 1
gitlab_mirror_alerts_active{severity="high"} 2
gitlab_mirror_alerts_active{severity="medium"} 3
gitlab_mirror_alerts_active{severity="low"} 3

# æ‰«æè€—æ—¶ï¼ˆç§’ï¼‰
gitlab_mirror_scan_duration_seconds{type="incremental"} 8.5
gitlab_mirror_scan_duration_seconds{type="full"} 45.2

# APIè°ƒç”¨æ¬¡æ•°
gitlab_mirror_api_calls_total{instance="source"} 12
gitlab_mirror_api_calls_total{instance="target"} 12

# é¡¹ç›®å‘ç°ç»Ÿè®¡
gitlab_mirror_projects_discovered{type="new"} 2
gitlab_mirror_projects_discovered{type="updated"} 8
```

#### é¡¹ç›®çº§æŒ‡æ ‡

```
# é¡¹ç›®æäº¤æ•°é‡ï¼ˆæº/ç›®æ ‡ï¼‰
gitlab_mirror_project_commits{project="ai/test-node-app2", type="source"} 245
gitlab_mirror_project_commits{project="ai/test-node-app2", type="target"} 240
gitlab_mirror_project_commits{project="arch/test-spring-app1", type="source"} 128
gitlab_mirror_project_commits{project="arch/test-spring-app1", type="target"} 128

# é¡¹ç›®æœ€åæäº¤æ—¶é—´ï¼ˆUnixæ—¶é—´æˆ³ï¼‰
gitlab_mirror_project_last_commit_time{project="ai/test-node-app2", type="source"} 1702536900
gitlab_mirror_project_last_commit_time{project="ai/test-node-app2", type="target"} 1702534200
gitlab_mirror_project_last_commit_time{project="arch/test-spring-app1", type="source"} 1702535000
gitlab_mirror_project_last_commit_time{project="arch/test-spring-app1", type="target"} 1702535000

# é¡¹ç›®ä»“åº“å¤§å°ï¼ˆå­—èŠ‚ï¼‰
gitlab_mirror_project_size_bytes{project="ai/test-node-app2", type="source"} 15925248
gitlab_mirror_project_size_bytes{project="ai/test-node-app2", type="target"} 15823456
gitlab_mirror_project_size_bytes{project="arch/test-spring-app1", type="source"} 8421504
gitlab_mirror_project_size_bytes{project="arch/test-spring-app1", type="target"} 8421504

# é¡¹ç›®åˆ†æ”¯æ•°é‡
gitlab_mirror_project_branches{project="ai/test-node-app2", type="source"} 3
gitlab_mirror_project_branches{project="ai/test-node-app2", type="target"} 3
gitlab_mirror_project_branches{project="arch/test-spring-app1", type="source"} 2
gitlab_mirror_project_branches{project="arch/test-spring-app1", type="target"} 2
```

**æŒ‡æ ‡è¯´æ˜**ï¼š

- **ç³»ç»Ÿçº§æŒ‡æ ‡**ï¼šç”¨äºæ•´ä½“ç›‘æ§ï¼Œç‰¹åˆ«æ˜¯`gitlab_mirror_sync_status`ç”¨äºç›‘æ§åŒæ­¥å¼‚å¸¸æ•°é‡
- **é¡¹ç›®çº§æŒ‡æ ‡**ï¼šæ”¯æŒç»†ç²’åº¦ç›‘æ§ï¼ŒtagsåŒ…æ‹¬`project`ï¼ˆé¡¹ç›®åï¼‰å’Œ`type`ï¼ˆsource/targetï¼‰
- **åŒæ­¥å·®å¼‚è®¡ç®—**ï¼šé€šè¿‡å¯¹æ¯”åŒä¸€é¡¹ç›®çš„sourceå’ŒtargetæŒ‡æ ‡å€¼ï¼Œè®¡ç®—åŒæ­¥å·®å¼‚
- **å‘Šè­¦è§„åˆ™**ï¼šåŸºäºé¡¹ç›®çº§æŒ‡æ ‡è®¾ç½®å‘Šè­¦ï¼ˆå¦‚commitå·®å¼‚ã€æ—¶é—´å»¶è¿Ÿç­‰ï¼‰

### Grafanaç›‘æ§é¢æ¿ç¤ºä¾‹

**é¢æ¿1ï¼šç³»ç»Ÿçº§ç›‘æ§**
- é¡¹ç›®æ€»æ•°è¶‹åŠ¿ï¼ˆæ—¶é—´åºåˆ—ï¼‰
- åŒæ­¥çŠ¶æ€åˆ†å¸ƒï¼ˆé¥¼å›¾ï¼‰- é‡ç‚¹å…³æ³¨å¼‚å¸¸æ•°é‡
- æ´»è·ƒå‘Šè­¦æ•°ï¼ˆæŒ‰ä¸¥é‡çº§åˆ«ï¼ŒæŸ±çŠ¶å›¾ï¼‰
- æ‰«æè€—æ—¶è¶‹åŠ¿ï¼ˆæ—¶é—´åºåˆ—ï¼‰

**é¢æ¿2ï¼šé¡¹ç›®çº§ç›‘æ§**
- Top 10 Commitå·®å¼‚é¡¹ç›®ï¼ˆè¡¨æ ¼ï¼Œå¯¹æ¯”source vs targetï¼‰
- é¡¹ç›®åŒæ­¥å»¶è¿Ÿåˆ†å¸ƒï¼ˆæ—¶é—´åºåˆ—ï¼ŒåŸºäºlast_commit_timeå·®å¼‚ï¼‰
- é¡¹ç›®å¤§å°Top 10ï¼ˆæŸ±çŠ¶å›¾ï¼‰
- åˆ†æ”¯æ•°é‡å¼‚å¸¸é¡¹ç›®ï¼ˆè¡¨æ ¼ï¼‰

**é¢æ¿3ï¼šå‘Šè­¦è¶‹åŠ¿**
- å‘Šè­¦è§¦å‘è¶‹åŠ¿ï¼ˆæ—¶é—´åºåˆ—ï¼‰
- æŒ‰ä¸¥é‡çº§åˆ«åˆ†ç»„ï¼ˆå †å æŸ±çŠ¶å›¾ï¼‰
- åŒæ­¥å¼‚å¸¸æ•°é‡è¶‹åŠ¿ï¼ˆæ—¶é—´åºåˆ—ï¼Œæ¥è‡ªgitlab_mirror_sync_statusï¼‰

**é¢æ¿4ï¼šæ€§èƒ½ç›‘æ§**
- APIè°ƒç”¨é¢‘ç‡ï¼ˆæ—¶é—´åºåˆ—ï¼‰
- é¡¹ç›®å‘ç°ç»Ÿè®¡ï¼ˆnew/updatedï¼‰
- æ‰¹é‡æŸ¥è¯¢æˆåŠŸç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰

**PromQLæŸ¥è¯¢ç¤ºä¾‹**ï¼š

```promql
# åŒæ­¥å¼‚å¸¸æ€»æ•°ï¼ˆoutdated + failed + inconsistentï¼‰
sum(gitlab_mirror_sync_status{status=~"outdated|failed|inconsistent"})

# æŸé¡¹ç›®çš„commitå·®å¼‚
gitlab_mirror_project_commits{project="ai/test-node-app2", type="source"} -
gitlab_mirror_project_commits{project="ai/test-node-app2", type="target"}

# æŸé¡¹ç›®çš„åŒæ­¥å»¶è¿Ÿï¼ˆç§’ï¼‰
gitlab_mirror_project_last_commit_time{project="ai/test-node-app2", type="source"} -
gitlab_mirror_project_last_commit_time{project="ai/test-node-app2", type="target"}

# Top 10 commitå·®å¼‚é¡¹ç›®
topk(10,
  gitlab_mirror_project_commits{type="source"} -
  gitlab_mirror_project_commits{type="target"} > 0
)
```

### å‘Šè­¦è§„åˆ™ç¤ºä¾‹

**Prometheuså‘Šè­¦è§„åˆ™**ï¼š

```yaml
groups:
  - name: gitlab_mirror_system_alerts
    interval: 1m
    rules:
      # åŒæ­¥å¼‚å¸¸æ•°é‡è¿‡å¤šï¼ˆé‡è¦ï¼‰
      - alert: GitLabMirrorSyncAnomaliesHigh
        expr: sum(gitlab_mirror_sync_status{status=~"outdated|failed|inconsistent"}) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "åŒæ­¥å¼‚å¸¸é¡¹ç›®æ•°é‡è¿‡å¤š"
          description: "å½“å‰æœ‰ {{ $value }} ä¸ªé¡¹ç›®åŒæ­¥å¼‚å¸¸"

      # åŒæ­¥å¤±è´¥æ•°é‡å‘Šè­¦
      - alert: GitLabMirrorSyncFailedHigh
        expr: gitlab_mirror_sync_status{status="failed"} > 2
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "åŒæ­¥å¤±è´¥é¡¹ç›®è¿‡å¤š"
          description: "å½“å‰æœ‰ {{ $value }} ä¸ªé¡¹ç›®åŒæ­¥å¤±è´¥"

      # Criticalå‘Šè­¦å­˜åœ¨
      - alert: GitLabMirrorCriticalAlerts
        expr: gitlab_mirror_alerts_active{severity="critical"} > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "å­˜åœ¨Criticalçº§åˆ«å‘Šè­¦"
          description: "å½“å‰æœ‰ {{ $value }} ä¸ªCriticalå‘Šè­¦"

      # æ‰«æè€—æ—¶è¿‡é•¿
      - alert: GitLabMirrorScanSlow
        expr: gitlab_mirror_scan_duration_seconds{type="incremental"} > 60
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "å¢é‡æ‰«æè€—æ—¶è¿‡é•¿"
          description: "æœ€è¿‘ä¸€æ¬¡æ‰«æè€—æ—¶ {{ $value }}ç§’"

  - name: gitlab_mirror_project_alerts
    interval: 1m
    rules:
      # é¡¹ç›®commitå·®å¼‚è¿‡å¤§
      - alert: GitLabMirrorProjectCommitDiffHigh
        expr: |
          (gitlab_mirror_project_commits{type="source"} -
           gitlab_mirror_project_commits{type="target"}) > 10
        for: 30m
        labels:
          severity: high
        annotations:
          summary: "é¡¹ç›® {{ $labels.project }} commitå·®å¼‚è¿‡å¤§"
          description: "æºå’Œç›®æ ‡commitå·®å¼‚ {{ $value }} ä¸ª"

      # é¡¹ç›®åŒæ­¥å»¶è¿Ÿè¿‡é•¿
      - alert: GitLabMirrorProjectSyncDelayHigh
        expr: |
          (gitlab_mirror_project_last_commit_time{type="source"} -
           gitlab_mirror_project_last_commit_time{type="target"}) > 3600
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "é¡¹ç›® {{ $labels.project }} åŒæ­¥å»¶è¿Ÿè¿‡é•¿"
          description: "åŒæ­¥å»¶è¿Ÿ {{ $value }} ç§’ï¼ˆè¶…è¿‡1å°æ—¶ï¼‰"

      # é¡¹ç›®å¤§å°å·®å¼‚è¿‡å¤§
      - alert: GitLabMirrorProjectSizeDiffHigh
        expr: |
          abs(gitlab_mirror_project_size_bytes{type="source"} -
              gitlab_mirror_project_size_bytes{type="target"}) /
          gitlab_mirror_project_size_bytes{type="source"} > 0.1
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "é¡¹ç›® {{ $labels.project }} å¤§å°å·®å¼‚è¿‡å¤§"
          description: "æºå’Œç›®æ ‡å¤§å°å·®å¼‚è¶…è¿‡10%"
```

### æ•°æ®åº“è¿ç§»è„šæœ¬

**æ‰©å±•SOURCE_PROJECT_INFO**ï¼š

```sql
ALTER TABLE source_project_info
ADD COLUMN latest_commit_sha VARCHAR(64) COMMENT 'æœ€æ–°æäº¤SHA',
ADD COLUMN commit_count INT COMMENT 'æäº¤æ•°é‡',
ADD COLUMN branch_count INT COMMENT 'åˆ†æ”¯æ•°é‡',
ADD COLUMN repository_size BIGINT COMMENT 'ä»“åº“å¤§å°ï¼ˆå­—èŠ‚ï¼‰',
ADD COLUMN last_activity_at DATETIME COMMENT 'æœ€åæ´»åŠ¨æ—¶é—´',
ADD INDEX idx_last_activity (last_activity_at);
```

**æ‰©å±•TARGET_PROJECT_INFO**ï¼š

```sql
ALTER TABLE target_project_info
ADD COLUMN latest_commit_sha VARCHAR(64) COMMENT 'æœ€æ–°æäº¤SHA',
ADD COLUMN commit_count INT COMMENT 'æäº¤æ•°é‡',
ADD COLUMN branch_count INT COMMENT 'åˆ†æ”¯æ•°é‡',
ADD COLUMN repository_size BIGINT COMMENT 'ä»“åº“å¤§å°ï¼ˆå­—èŠ‚ï¼‰',
ADD COLUMN last_activity_at DATETIME COMMENT 'æœ€åæ´»åŠ¨æ—¶é—´',
ADD INDEX idx_last_activity (last_activity_at);
```

**åˆ›å»ºMONITOR_ALERTè¡¨**ï¼š

```sql
CREATE TABLE monitor_alert (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  sync_project_id BIGINT NOT NULL COMMENT 'å…³è”é¡¹ç›®ID',
  alert_type VARCHAR(50) NOT NULL COMMENT 'å‘Šè­¦ç±»å‹',
  severity VARCHAR(20) NOT NULL COMMENT 'ä¸¥é‡ç¨‹åº¦',
  title VARCHAR(255) NOT NULL COMMENT 'å‘Šè­¦æ ‡é¢˜',
  description TEXT NOT NULL COMMENT 'å‘Šè­¦æè¿°',
  metadata TEXT COMMENT 'å…ƒæ•°æ®JSON',
  status VARCHAR(20) NOT NULL DEFAULT 'active' COMMENT 'çŠ¶æ€',
  triggered_at DATETIME NOT NULL COMMENT 'è§¦å‘æ—¶é—´',
  resolved_at DATETIME COMMENT 'è§£å†³æ—¶é—´',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME ON UPDATE CURRENT_TIMESTAMP,

  INDEX idx_project (sync_project_id),
  INDEX idx_status_severity (status, severity, triggered_at),
  INDEX idx_type (alert_type, triggered_at),

  FOREIGN KEY (sync_project_id) REFERENCES sync_project(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç›‘æ§å‘Šè­¦è¡¨';
```

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒä»·å€¼

1. **æ¨¡å—åŒ–è®¾è®¡**ï¼š
   - åŒæ­¥æ¨¡å—ï¼šæŸ¥è¯¢ã€æ‰«æã€é¡¹ç›®å‘ç°
   - ç›‘æ§æ¨¡å—ï¼šæŒ‡æ ‡å¯¼å‡ºã€å‘Šè­¦ç®¡ç†
   - æ¸…æ™°çš„APIå’ŒCLIåˆ’åˆ†

2. **è½»é‡åŒ–å®ç°**ï¼š
   - å¤ç”¨ç°æœ‰è¡¨ï¼Œå·®å¼‚ä»…ç¼“å­˜å†…å­˜
   - å‡å°‘å­˜å‚¨å¼€é”€
   - æå‡æŸ¥è¯¢æ€§èƒ½

3. **é«˜æ•ˆæ‰¹é‡æŸ¥è¯¢**ï¼š
   - å¢é‡æŸ¥è¯¢ï¼ˆ`updated_after`ï¼‰
   - å¹¶å‘æŸ¥è¯¢æºå’Œç›®æ ‡
   - APIè°ƒç”¨å‡å°‘90%

4. **åŒå±‚æŒ‡æ ‡ä½“ç³»**ï¼š
   - ç³»ç»Ÿçº§æŒ‡æ ‡ï¼šæ•´ä½“ç›‘æ§ï¼ŒåŒæ­¥å¼‚å¸¸æ•°é‡å‘Šè­¦
   - é¡¹ç›®çº§æŒ‡æ ‡ï¼šç»†ç²’åº¦ç›‘æ§ï¼Œæ”¯æŒå·®å¼‚å¯¹æ¯”
   - é€šè¿‡tagså®ç°çµæ´»çš„PromQLæŸ¥è¯¢

5. **æ™ºèƒ½å‘Šè­¦**ï¼š
   - ä»…åœ¨å¼‚å¸¸æ—¶è®°å½•å‘Šè­¦
   - æ”¯æŒç³»ç»Ÿçº§å’Œé¡¹ç›®çº§å‘Šè­¦è§„åˆ™
   - å‘Šè­¦ä¸¥é‡çº§åˆ«è‡ªåŠ¨åˆ¤å®š

6. **å®Œæ•´ç›‘æ§ä½“ç³»**ï¼š
   - é¡¹ç›®å‘ç° + åŒæ­¥ç›‘æ§
   - CLIå¿«é€Ÿè¯Šæ–­
   - Grafanaå¯è§†åŒ–
   - AlertManagerå‘Šè­¦é€šçŸ¥

### å®æ–½è·¯å¾„

#### é˜¶æ®µä¸€ï¼šæ•°æ®æ¨¡å‹ï¼ˆ2å¤©ï¼‰
- [ ] æ‰©å±•SOURCE_PROJECT_INFOå’ŒTARGET_PROJECT_INFOè¡¨
- [ ] åˆ›å»ºMONITOR_ALERTè¡¨
- [ ] ç¼–å†™æ•°æ®åº“è¿ç§»è„šæœ¬

#### é˜¶æ®µäºŒï¼šæ‰¹é‡æŸ¥è¯¢ï¼ˆ3å¤©ï¼‰
- [ ] å®ç°BatchQueryExecutor
- [ ] æ”¯æŒå¢é‡æŸ¥è¯¢ï¼ˆupdated_afterï¼‰
- [ ] å®ç°å¹¶å‘æŸ¥è¯¢ä¼˜åŒ–

#### é˜¶æ®µä¸‰ï¼šå·®å¼‚è®¡ç®—ï¼ˆ3å¤©ï¼‰
- [ ] å®ç°DiffCalculatorï¼ˆå†…å­˜è®¡ç®—ï¼‰
- [ ] å®ç°Redisç¼“å­˜
- [ ] å®ç°å‘Šè­¦é˜ˆå€¼åˆ¤å®š

#### é˜¶æ®µå››ï¼šä¸šåŠ¡é€»è¾‘ï¼ˆ4å¤©ï¼‰
- [ ] æ•´åˆé¡¹ç›®å‘ç°é€»è¾‘
- [ ] å®ç°åŒæ­¥ç›‘æ§é€»è¾‘
- [ ] å®ç°å‘Šè­¦äº‹ä»¶åˆ›å»º

#### é˜¶æ®µäº”ï¼šPrometheuså¯¼å‡ºï¼ˆ2å¤©ï¼‰
- [ ] å®ç°MetricsExporter
- [ ] å®šä¹‰PrometheusæŒ‡æ ‡
- [ ] æµ‹è¯•Grafanaé›†æˆ

#### é˜¶æ®µå…­ï¼šAPIå’ŒCLIï¼ˆ3å¤©ï¼‰
- [ ] å®ç°REST API
- [ ] å®ç°CLIå‘½ä»¤
- [ ] ç¾åŒ–è¾“å‡ºæ ¼å¼

#### é˜¶æ®µä¸ƒï¼šæµ‹è¯•å’Œä¸Šçº¿ï¼ˆ3å¤©ï¼‰
- [ ] å•å…ƒæµ‹è¯•
- [ ] é›†æˆæµ‹è¯•
- [ ] é…ç½®Grafanaé¢æ¿
- [ ] é…ç½®AlertManagerè§„åˆ™
- [ ] ç”Ÿäº§éƒ¨ç½²

**æ€»è®¡**ï¼šçº¦ **20å¤©**ï¼ˆ3å‘¨ï¼‰

### æ³¨æ„äº‹é¡¹

#### æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨Redisç¼“å­˜å‡å°‘é‡å¤è®¡ç®—
- æ‰¹é‡æŸ¥è¯¢åˆ†æ‰¹å¹¶å‘æ‰§è¡Œ
- å®šæœŸæ¸…ç†è¿‡æœŸå‘Šè­¦ï¼ˆå·²è§£å†³è¶…è¿‡30å¤©ï¼‰

#### å‘Šè­¦ç®¡ç†

- å®ç°å‘Šè­¦å»é‡ï¼ˆåŒä¸€é¡¹ç›®åŒä¸€ç±»å‹60åˆ†é’Ÿå†…ä¸é‡å¤ï¼‰
- æ”¯æŒå‘Šè­¦é™é»˜ï¼ˆç»´æŠ¤æœŸé—´ï¼‰
- è‡ªåŠ¨è§£å†³å·²ä¿®å¤çš„å‘Šè­¦

#### ç›‘æ§è¿ç»´

- PrometheusæŠ“å–é—´éš”å»ºè®®1åˆ†é’Ÿ
- Grafanaé¢æ¿è‡ªåŠ¨åˆ·æ–°é—´éš”5åˆ†é’Ÿ
- å‘Šè­¦é€šçŸ¥æ¸ é“ï¼šé‚®ä»¶/ä¼ä¸šå¾®ä¿¡/é’‰é’‰

---

**æ ¸å¿ƒè¦ç‚¹**ï¼šæ¨¡å—åŒ–è®¾è®¡ã€å¤ç”¨ç°æœ‰è¡¨ã€å†…å­˜å·®å¼‚è®¡ç®—ã€åŒå±‚æŒ‡æ ‡ä½“ç³»ï¼ˆç³»ç»Ÿçº§+é¡¹ç›®çº§ï¼‰ã€å‘Šè­¦é©±åŠ¨ã€Prometheuså¯¼å‡ºã€‚
