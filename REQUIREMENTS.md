# GitLab 同步器 - 需求清单

## 📋 项目概述

开发一个 GitLab 同步器，用于将源 GitLab 实例的分组、项目及相关数据同步到目标 GitLab 实例，保持原始路径结构不变。

---

## 🎯 核心需求

### 1. 基础同步功能

#### 1.1 分组（Group）同步
- [ ] **分组结构复制**
  - 复制所有分组（包括顶层分组和子分组）
  - 保持原始的层级关系
  - 保持分组路径不变（如 `group/subgroup`）

- [ ] **分组元数据**
  - 分组名称、描述
  - 分组可见性（Private/Internal/Public）
  - 分组头像/Logo
  - 分组设置（权限、共享设置等）

#### 1.2 项目（Project）同步
- [ ] **Git 仓库同步（核心功能）**
  - 完整克隆源项目的 Git 仓库
  - 同步所有分支（branches）
  - 同步所有标签（tags）
  - 同步所有提交历史（commits）
  - 保持项目路径不变（如 `group/subgroup/project`）

- [ ] **项目元数据**
  - 项目名称、描述
  - 项目可见性（Private/Internal/Public）
  - 项目头像
  - 项目设置（默认分支、保护分支等）
  - 项目成员及权限

#### 1.3 扩展数据同步（优先级：中高）
- [ ] **Merge Requests（合并请求）**
  - MR 标题、描述、状态
  - MR 评论（Comments/Discussions）
  - MR 审批记录
  - MR 关联的提交
  - MR 标签（Labels）
  - MR 里程碑（Milestones）

- [ ] **Issues（问题）**
  - Issue 标题、描述、状态
  - Issue 评论
  - Issue 标签
  - Issue 里程碑
  - Issue 分配者
  - Issue 关联关系

- [ ] **其他项目数据**
  - Wiki 内容
  - Snippets（代码片段）
  - Labels（标签定义）
  - Milestones（里程碑定义）
  - Release Notes（发布说明）
  - CI/CD Pipelines 配置（`.gitlab-ci.yml`）

---

## 🔧 技术需求

### 2. 同步方式

#### 2.1 全量同步
- [ ] 首次同步时，完整复制所有数据
- [ ] 支持断点续传（中断后可继续）
- [ ] 同步进度展示

#### 2.2 增量同步（可选）
- [ ] 检测源 GitLab 的变更
- [ ] 仅同步新增或修改的内容
- [ ] 支持定时增量同步
- [ ] 支持 Webhook 触发的实时同步

#### 2.3 同步策略
- [ ] **覆盖模式**：目标存在时覆盖
- [ ] **跳过模式**：目标存在时跳过
- [ ] **合并模式**：智能合并（如增量更新 MR/Issues）
- [ ] **冲突处理**：提供冲突解决策略

---

## 🛠️ 功能特性

### 3. 核心功能

#### 3.1 连接管理
- [ ] 支持配置源 GitLab 和目标 GitLab
  - GitLab URL
  - Access Token
  - API 版本
- [ ] 连接测试功能
- [ ] 支持自签名证书（Self-signed SSL）

#### 3.2 选择性同步
- [ ] **分组筛选**
  - 按分组路径筛选
  - 支持正则表达式匹配
  - 支持黑白名单

- [ ] **项目筛选**
  - 按项目路径筛选
  - 按项目可见性筛选
  - 按项目活跃度筛选（如最后更新时间）
  - 支持黑白名单

- [ ] **数据类型选择**
  - 仅同步 Git 仓库
  - 同步 Git + MR
  - 同步 Git + Issues
  - 完整同步（所有数据）

#### 3.3 路径映射
- [ ] **保持原路径**（默认）
  - `source.gitlab.com/group/project` → `target.gitlab.com/group/project`

- [ ] **自定义路径映射**（可选）
  - 支持路径前缀替换
  - 支持路径重命名规则
  - 示例：`old-group/project` → `new-group/project`

#### 3.4 权限处理
- [ ] **用户映射**
  - 源 GitLab 用户 → 目标 GitLab 用户映射
  - 不存在的用户处理策略（跳过/创建占位符/映射到管理员）

- [ ] **成员权限同步**
  - 同步分组成员及权限
  - 同步项目成员及权限
  - 处理权限冲突

---

## 📊 监控与日志

### 4. 可观测性

#### 4.1 进度监控
- [ ] **实时同步进度**
  - 当前同步的分组/项目路径
  - 已完成/总数统计
  - 预计剩余时间
  - 当前同步阶段（初始化/Git同步/元数据同步/验证/清理）

- [ ] **性能指标展示**
  - 平均任务耗时
  - 网络吞吐量（MB/s）
  - 成功率统计
  - 当前并发任务数

#### 4.2 日志记录

- [ ] **结构化日志（JSON 格式）**
  - 任务级日志：记录每个同步任务的完整信息
  - 阶段级日志：记录主要阶段（初始化、Git同步、元数据同步、验证、清理）的耗时
  - 操作级日志：记录具体操作（git clone、git push、API调用）的详细信息

- [ ] **性能分析日志**
  - 记录每个步骤的耗时（毫秒级精度）
  - 记录数据传输量（字节数）
  - 记录传输速度（MB/s）
  - 记录 Git 对象数量（commits、branches、tags）
  - 便于后续性能优化和瓶颈识别

- [ ] **日志级别**
  - DEBUG：详细 API 调用、Git 命令执行、数据处理细节
  - INFO：任务开始/完成、重要里程碑、统计信息
  - WARN：非致命错误、降级处理、性能告警
  - ERROR：任务失败、异常信息、堆栈跟踪

- [ ] **日志输出**
  - 控制台输出（彩色日志、进度条）
  - 文件输出（带轮转、压缩）
  - 结构化日志文件（JSON 格式，便于分析工具解析）

- [ ] **日志管理**
  - 日志文件自动轮转（按大小或时间）
  - 旧日志自动压缩
  - 日志保留策略（按数量或时间）
  - 可选的日志聚合（ELK/Loki 集成）

#### 4.3 同步状态监控

- [ ] **项目状态数据库**
  - 记录每个项目的同步状态（已同步/失败/分歧/待同步）
  - 记录源和目标仓库的元信息（分支数、标签数、最后提交SHA、提交时间）
  - 记录最后同步时间、同步耗时、同步策略
  - 记录一致性状态（一致/不一致）
  - 记录差异摘要（缺失分支、多余分支、SHA不匹配的分支）

- [ ] **状态查询功能**
  - CLI 命令查看所有项目状态
  - 按状态过滤（已同步/失败/分歧/待同步）
  - 按一致性过滤（一致/不一致）
  - 查看特定项目的详细状态
  - 查看项目差异详情（源 vs 目标对比）
  - 导出状态报告（JSON/CSV/文本）

- [ ] **Web UI 监控界面（服务模式）**
  - Dashboard 总览页面（总项目数、状态分布、健康度）
  - 项目列表页面（可搜索、过滤、排序）
  - 项目详情页面（Git 状态、差异详情、同步历史、操作按钮）
  - 任务列表页面（实时任务状态、查看日志、重试操作）
  - 性能分析页面（耗时趋势图、慢查询列表、瓶颈识别）
  - 实时更新（WebSocket 推送）

- [ ] **RESTful API**
  - GET /api/status - 获取总体状态
  - GET /api/projects - 获取项目列表（支持过滤、分页）
  - GET /api/projects/:id - 获取项目详情
  - GET /api/projects/:id/diff - 获取项目差异
  - POST /api/projects/:id/sync - 触发项目同步
  - GET /api/tasks - 获取任务列表
  - GET /api/tasks/:id - 获取任务详情
  - GET /api/tasks/:id/logs - 获取任务日志
  - GET /api/metrics/performance - 获取性能指标

#### 4.4 一致性检查

- [ ] **定期自动巡检**
  - 定时检查所有项目的一致性（如每小时）
  - 使用 git ls-remote 对比源和目标的 refs
  - 对比分支数量、标签数量、每个 ref 的 SHA
  - 获取默认分支的最后提交信息
  - 更新项目状态数据库

- [ ] **巡检报告**
  - 生成一致性检查报告
  - 列出一致项目数量、分歧项目数量、检查失败数量
  - 详细列出分歧项目及差异类型
  - 提供修复建议

- [ ] **手动一致性检查**
  - CLI 命令手动触发检查
  - 支持检查所有项目或特定项目
  - 后台运行并生成报告

#### 4.5 性能分析工具

- [ ] **日志分析命令**
  - 生成耗时统计报告（按阶段聚合）
  - 识别性能瓶颈（最慢的操作）
  - 性能趋势分析（跨多次同步对比）
  - 瓶颈识别并输出优化建议
  - 多种输出格式（文本表格、CSV、JSON）

- [ ] **实时性能仪表盘（服务模式）**
  - 耗时分布饼图（各阶段占比）
  - 历史趋势图（按日期）
  - 慢查询列表（Top 10/20 最慢项目）
  - 吞吐量图表（项目数/小时）
  - 错误率趋势

#### 4.6 统计报告

- [ ] **同步完成报告**
  - 执行摘要（开始时间、结束时间、总耗时）
  - 成功率统计
  - 数据量统计（仓库数、分支数、标签数、提交数）
  - 成功列表（项目路径、同步策略、耗时、数据量）
  - 失败列表（项目路径、失败原因、错误详情、建议解决方案）
  - 跳过列表（项目路径、跳过原因）

- [ ] **一致性验证报告（严格）**
  - 分组数量对比（必须 100% 一致）
  - 项目数量对比（必须 100% 一致）
  - Git 仓库验证（分支/标签数量、所有 refs 的 SHA 对比）
  - 元数据数量对比（Issues、MR 数量）
  - 一致性结论（完全一致 or 存在差异需人工介入）

- [ ] **报告格式**
  - 纯文本（.txt）
  - Markdown（.md）
  - HTML（.html，带样式）
  - JSON（.json，机器可读）

#### 4.7 告警机制

- [ ] **告警类型**
  - 同步失败告警（失败 N 次后触发）
  - 一致性分歧告警（发现源和目标不一致）
  - 性能退化告警（耗时超过历史平均值 X 倍）
  - 长时间未同步告警（超过 N 小时未同步）

- [ ] **告警渠道**
  - 邮件告警（SMTP 配置）
  - 钉钉告警（Webhook + Secret）
  - 企业微信告警
  - Slack 告警
  - 自定义 Webhook（POST JSON）

- [ ] **告警配置**
  - 可配置告警开关
  - 可配置告警阈值
  - 可配置告警接收人
  - 支持告警静默期

---

## ⚙️ 运行模式

### 5. 部署与运行

#### 5.1 运行方式
- [ ] **命令行工具（CLI）**
  - 一次性执行
  - 支持命令行参数配置
  - 交互式配置

- [ ] **配置文件驱动**
  - YAML/JSON 配置文件
  - 支持配置模板
  - 配置验证

- [ ] **定时任务**
  - 支持 Cron 表达式
  - 定时增量同步

- [ ] **服务模式**（可选）
  - HTTP API 接口
  - Web UI 管理界面
  - Webhook 接收器

#### 5.2 部署方式
- [ ] **本地运行**
  - Python/Go/Node.js 脚本
  - 可执行文件

- [ ] **Docker 容器**
  - Docker 镜像
  - Docker Compose 部署

- [ ] **Kubernetes**（可选）
  - Helm Chart
  - CronJob 定时同步

---

## 🔒 安全与容错

### 6. 安全性

#### 6.1 认证授权
- [ ] **Access Token 管理**
  - Token 安全存储（加密）
  - Token 有效性检查
  - 最小权限原则（仅需要的 API 权限）

- [ ] **数据安全**
  - HTTPS 连接
  - 敏感数据脱敏（日志中）

#### 6.2 容错处理
- [ ] **网络异常**
  - 自动重试机制
  - 超时配置
  - 断点续传

- [ ] **API 限流**
  - 遵守 GitLab API Rate Limit
  - 自动降速
  - 队列管理

- [ ] **错误恢复**
  - 失败项目记录
  - 支持单独重试失败项
  - 事务性操作（尽可能）

---

## 🎨 用户体验

### 7. 易用性

#### 7.1 配置简化
- [ ] **配置向导**
  - 交互式配置生成
  - 配置验证

- [ ] **预设模板**
  - 常用场景模板
  - 一键配置

#### 7.2 文档
- [ ] **使用文档**
  - 快速开始指南
  - 配置说明
  - 常见问题（FAQ）

- [ ] **示例**
  - 配置文件示例
  - 命令行示例
  - 场景案例

---

## 🚀 性能需求

### 8. 性能指标

#### 8.1 同步性能
- [ ] **并发处理**
  - 支持并发同步多个项目
  - 可配置并发数量
  - 资源限制（CPU/内存/网络）

- [ ] **大仓库优化**
  - 支持浅克隆（Shallow Clone）
  - 增量传输优化
  - LFS（Large File Storage）支持

#### 8.2 资源占用
- [ ] 内存占用合理（可配置）
- [ ] 磁盘空间管理（临时文件清理）
- [ ] 网络带宽控制（可选）

---

## 🔄 扩展性

### 9. 扩展功能（未来）

#### 9.1 高级特性
- [ ] **双向同步**
  - 源 ↔ 目标双向同步
  - 冲突检测与解决

- [ ] **多源同步**
  - 多个源 GitLab → 单个目标
  - 路径去重与合并

- [ ] **过滤与转换**
  - 数据过滤规则（如排除特定分支）
  - 数据转换（如批量重命名）

#### 9.2 集成能力
- [ ] Webhook 集成
- [ ] CI/CD 集成
- [ ] 第三方通知（Slack/Email/钉钉）

---

## 📦 技术栈建议

### 10. 实现方案

#### 10.1 推荐技术
- **语言**: Python / Go / Node.js
- **GitLab API**:
  - GitLab REST API
  - GitLab GraphQL API（可选）
- **Git 操作**:
  - GitPython / go-git / nodegit
  - 或直接调用 git 命令

#### 10.2 核心依赖
- **API 客户端**:
  - Python: `python-gitlab`
  - Go: `go-gitlab`
  - Node.js: `@gitbeaker/node`
- **Git 库**:
  - Python: `GitPython`
  - Go: `go-git`
  - Node.js: `nodegit` 或 `simple-git`
- **配置管理**: YAML/TOML 解析库
- **日志**: 结构化日志库
- **并发**: 线程池/协程/Goroutine

---

## 📝 优先级划分

### P0 - 核心功能（必须）
1. ✅ 分组结构同步
2. ✅ Git 仓库完整同步（branches/tags/commits）
3. ✅ 保持原路径不变
4. ✅ 基础错误处理与日志
5. ✅ 配置文件支持

### P1 - 重要功能（高优先级）
1. ✅ Merge Requests 同步
2. ✅ Issues 同步
3. ✅ 增量同步
4. ✅ 并发处理
5. ✅ 进度监控
6. ✅ 用户/权限映射

### P2 - 增强功能（中优先级）
1. ⚪ Wiki/Snippets/Labels 同步
2. ⚪ 选择性同步（黑白名单）
3. ⚪ 断点续传
4. ⚪ Web UI
5. ⚪ Docker 部署

### P3 - 扩展功能（低优先级）
1. ⚪ 双向同步
2. ⚪ 多源同步
3. ⚪ Webhook 集成
4. ⚪ 高级过滤与转换

---

## 🗓️ 开发建议

### Phase 1: MVP（最小可行产品）
**目标**: 实现基础的 Git 仓库同步

- [ ] 源/目标 GitLab 连接
- [ ] 分组列表获取
- [ ] 项目列表获取
- [ ] Git 仓库克隆与推送
- [ ] 基础日志

**预计时间**: 1-2 周

### Phase 2: 核心功能完善
**目标**: 支持 MR/Issues 同步

- [ ] MR 数据同步
- [ ] Issues 数据同步
- [ ] 用户映射
- [ ] 错误处理优化

**预计时间**: 2-3 周

### Phase 3: 性能与易用性
**目标**: 优化性能和用户体验

- [ ] 并发处理
- [ ] 增量同步
- [ ] 进度监控
- [ ] 配置向导

**预计时间**: 1-2 周

### Phase 4: 生产就绪
**目标**: 稳定性与部署

- [ ] 完善文档
- [ ] Docker 化
- [ ] 容错增强
- [ ] 性能调优

**预计时间**: 1-2 周

---

## 📋 验收标准

### 功能验收
- [ ] 能够完整同步分组结构
- [ ] 能够完整同步 Git 仓库（所有分支和标签）
- [ ] 同步后路径与源保持一致
- [ ] MR 和 Issues 数据完整（包括评论）
- [ ] 同步失败时有清晰的错误提示
- [ ] 生成完整的同步报告

### 性能验收
- [ ] 单个项目同步时间 < 5 分钟（中等大小仓库）
- [ ] 支持并发同步至少 5 个项目
- [ ] 内存占用 < 2GB（并发 5 个项目）

### 质量验收
- [ ] 代码覆盖率 > 60%
- [ ] 无已知的严重 Bug
- [ ] 文档完整可用

---

## 🤔 关键问题与决策

### 需要明确的问题

1. **同步范围**
   - 是否需要同步所有历史数据？
   - MR/Issues 的评论是否需要保留作者信息？
   - 是否需要同步已关闭/已合并的 MR？

2. **用户映射**
   - 源/目标用户不存在时如何处理？
   - 是否需要自动创建用户？

3. **冲突处理**
   - 目标已存在同名项目时如何处理？
   - 数据冲突时的优先级策略？

4. **性能 vs 完整性**
   - 是否可以接受浅克隆（损失部分历史）？
   - 是否可以跳过大文件？

5. **运行模式**
   - 一次性同步还是持续同步？
   - 是否需要 Web UI？

---

## 📚 参考资源

- [GitLab API 文档](https://docs.gitlab.com/ee/api/)
- [GitLab 项目导入/导出](https://docs.gitlab.com/ee/user/project/settings/import_export.html)
- [python-gitlab 库](https://python-gitlab.readthedocs.io/)
- [GitLab Webhooks](https://docs.gitlab.com/ee/user/project/integrations/webhooks.html)

---

**文档版本**: v1.0
**创建日期**: 2025-12-13
**最后更新**: 2025-12-13
